
<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Job Card / Route Card - Cloud App (PWA) with Full Access</title>
  
  <link rel="manifest" href="manifest.json">
  
  <script>
    // üîí SECURITY Enhancement: Disable Right Click and Developer Tools Access
    document.addEventListener('contextmenu', event => event.preventDefault()); 
    document.onkeydown = function(e) {
        if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.ctrlKey && e.shiftKey && e.key === 'J' || e.ctrlKey && e.shiftKey && e.key === 'K'))) {
            return false;
        }
        if (e.ctrlKey && e.key === 'u') {
            return false;
        }
    };
  </script>
  
  <script type="module">
        // --- FIREBASE CONFIGURATION ---
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, getDocs, deleteDoc, query, where } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyAaQoa6pSF7ZEPne6BYT8V7l6OslHPTYjw",
            authDomain: "jobcard-app-7b99c.firebaseapp.com",
            projectId: "jobcard-app-7b99c",
            storageBucket: "jobcard-app-7b99c.firebasestorage.app",
            messagingSenderId: "36117182109",
            appId: "1:36117182109:web:3007d2193063100d3c4674"
        };
        
        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.auth = getAuth(app); 

        let currentUserRole = 'admin'; 
        let currentView = 'home'; 

        window.updateActionButtons = function(reportData) {
            const isReportLoaded = reportData && reportData.uniqueId && !reportData.uniqueId.startsWith('NEW_');
            const isCompleted = document.getElementById('statusField')?.value === 'Completed';
            const isLoggedIn = currentUserRole !== 'logged_out';

            document.getElementById('saveReport').disabled = !isLoggedIn;
            document.getElementById('deleteReport').disabled = !(isLoggedIn && isReportLoaded);
            document.getElementById('completeReportBtn').disabled = !(isReportLoaded && isLoggedIn && !isCompleted);

            document.querySelectorAll('.form input, .form select, .form button:not(#loginButton, #signUpButton, #logoutButton, #homeViewBtn, #formViewBtn, #newJobFromHome)').forEach(el => {
                el.disabled = !isLoggedIn;
            });
             
            // Re-enable form fields that need to run custom disabling logic later
            document.getElementById('baseBatch').disabled = !isLoggedIn;
            document.getElementById('topBatch').disabled = !isLoggedIn;


            document.getElementById('applyBtn').disabled = !isLoggedIn;
            document.getElementById('updateOpsBtn').disabled = !isLoggedIn;

            document.getElementById('currentReportId').textContent = `Active ID: ${reportData && reportData.uniqueId ? (reportData.uniqueId.startsWith('NEW') ? '-- New --' : reportData.uniqueId) : '-- New --'}`;
            
            if (isReportLoaded && isLoggedIn) {
                document.getElementById('saveReport').textContent = 'üíæ Update Report';
            } else if (isLoggedIn) {
                document.getElementById('saveReport').textContent = 'üíæ Save New Report';
            } else {
                 document.getElementById('saveReport').textContent = '‚ö†Ô∏è Log In to Save';
            }
            
            // Important: Re-apply batch validation to set the correct state for coating ops
            window.handleBatchNoValidation();
        };

        window.handleAuthAction = async (actionType) => {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            if (actionType !== 'logout' && (!email || !password)) {
                alert("Please enter email and password.");
                return;
            }

            try {
                if (actionType === 'signup') {
                    await createUserWithEmailAndPassword(window.auth, email, password);
                    alert(`‚úÖ Signed Up and Logged In as ${email}. Full access enabled.`);
                } else if (actionType === 'signin') {
                    await signInWithEmailAndPassword(window.auth, email, password);
                    alert(`‚úÖ Signed In as ${email}.`);
                } else if (actionType === 'logout') {
                    await signOut(window.auth);
                    alert("üëã Logged Out successfully!");
                }
            } catch (error) {
                alert(`‚ùå Auth Failed: ${error.message}`);
            }
        }

        window.updateAuthUI = async (user) => {
            const loggedOutUI = document.getElementById('loggedOutUI');
            const loggedInUI = document.getElementById('loggedInUI');
            const authStatus = document.getElementById('authStatus');
            const userEmailDisplay = document.getElementById('userEmailDisplay');
            
            if (user) {
                loggedOutUI.style.display = 'none';
                loggedInUI.style.display = 'flex';
                currentUserRole = 'admin'; 
                userEmailDisplay.textContent = `User: ${user.email} | Role: FULL ACCESS`;
                authStatus.textContent = `Status: Logged In (Cloud Active)`;
                authStatus.style.color = '#059669';
                showView('home');
            } else {
                loggedOutUI.style.display = 'flex';
                loggedInUI.style.display = 'none';
                authStatus.textContent = "Status: Logged Out (Cloud Disabled)";
                authStatus.style.color = '#dc2626';
                currentUserRole = 'logged_out';
            }
            
            const activeData = currentActiveReportId ? getFormData() : null;
            window.updateActionButtons(activeData);
        };

        onAuthStateChanged(window.auth, (user) => {
            window.updateAuthUI(user);
        });
        
        window.cloudSaveReport = async (data, docId) => {
            if (!window.auth.currentUser) throw new Error("User not logged in.");
            const record = {
                ...data, 
                timestamp: data.timestamp || new Date().toISOString(), 
                savedBy: window.auth.currentUser.email,
                updatedAt: new Date().toISOString(), 
                status: data.status || 'Running' 
            };
             await setDoc(doc(window.db, 'job_cards', docId), record); 
        };
        
        window.cloudLoadReports = async (queryTerm = '', statusFilter = 'Running') => {
            if (!window.auth.currentUser) return [];
            const reports = [];
            let qRef = collection(window.db, 'job_cards');
            
            let q = query(qRef, where("status", "==", statusFilter));

            const querySnapshot = await getDocs(q);
            
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                data.uniqueId = doc.id; 
                
                const searchString = `${data.challan} ${data.batchNo} ${data.customerName} ${data.partDesc} ${data.uniqueId}`.toLowerCase();
                if (!queryTerm || searchString.includes(queryTerm.toLowerCase())) {
                    reports.push(data);
                }
            });

            return reports.sort((a,b) => new Date(b.updatedAt) - new Date(a.updatedAt));
        };

        window.cloudDeleteReport = async (docId) => {
            if (!window.auth.currentUser) throw new Error("User not logged in.");
            await deleteDoc(doc(window.db, 'job_cards', docId));
        };

        function showView(view) {
            const homePanel = document.getElementById('homePanel');
            const formPanel = document.querySelector('.form');
            const previewPanel = document.querySelector('.preview-wrap');
            const homeViewBtn = document.getElementById('homeViewBtn');
            const formViewBtn = document.getElementById('formViewBtn');
        
            currentView = view;
            
            if (view === 'home') {
                homePanel.style.display = 'flex';
                formPanel.style.display = 'none';
                previewPanel.style.display = 'none';
                homeViewBtn.style.display = 'none';
                formViewBtn.style.display = 'block';
                if (window.auth.currentUser) {
                    window.loadReportsList('', 'Running'); 
                    window.loadReportsList('', 'Completed'); 
                }
            } else { 
                formPanel.style.display = 'block';
                previewPanel.style.display = 'flex';
                homePanel.style.display = 'none';
                homeViewBtn.style.display = 'block';
                formViewBtn.style.display = 'none';
            }
        }
        window.showView = showView; 
        
    window.checkMasterPassword = checkMasterPassword;

    
    function checkMasterPassword() {
    const pass = document.getElementById('masterPassField').value;
    const correctPass = "1234"; // ‡§Ü‡§™‡§ï‡§æ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°

    if (pass === correctPass) {
        document.getElementById('gatekeeperOverlay').style.display = 'none';
        // ‡§Ø‡§π‡§æ‡§Å appBody ‡§ï‡•ã ‡§¶‡§ø‡§ñ‡§æ‡§®‡§æ ‡•õ‡§∞‡•Ç‡§∞‡•Ä ‡§π‡•à
        document.getElementById('appBody').style.display = 'block'; 
        document.getElementById('mainAppWrapper').style.display = 'block';
    } else {
        document.getElementById('wrongPassMsg').style.display = 'block';
        document.getElementById('masterPassField').value = '';
    }
}

    </script>
    
  <style>
    /* ------------------- STYLES: UPDATED FOR 5MM/18MM HEIGHT ------------------- */
    body { font-family: Arial, sans-serif; margin: 12px; background:#f5f5f5; font-size: 14px; }
    .container { display: flex; gap: 12px; min-height: 85vh; }
    .panel { background: white; padding: 12px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,.08); }
    .form { width: 36%; max-width:420px; overflow-y:auto; height:85vh; flex-shrink: 0; } 
    .preview-wrap { width: 64%; display:flex; flex-direction:column; gap:8px; align-items:center; flex-grow: 1; min-width: 300px; }
    .preview { 
        width:100%; 
        max-width:210mm; 
        height: auto; 
        min-height: 297mm; 
        background:white; 
        box-shadow:0 2px 8px rgba(0,0,0,.12); 
        padding:12mm; 
        box-sizing:border-box; 
        overflow-x: auto; 
        font-size: 10px; 
    } 
    h2 { text-align:center; margin:0 0 8px 0; font-size:18px; }
    label { display:block; font-size:13px; margin-top:8px; }
    input[type="text"], input[type="date"], input[type="email"], input[type="time"], select { width:100%; padding:6px 8px; margin-top:4px; box-sizing:border-box; border: 1px solid #ccc; border-radius: 4px; }
    .top-grid { display:flex; gap:8px; }
    .top-grid > div { flex:1; }
    .actions { display:flex; gap:8px; margin-top:8px; }
    button { padding:8px 10px; border: none; background:#2563eb; color:white; border-radius:6px; cursor:pointer; font-size: 14px;}
    button.secondary { background:#6b7280; }
    button.delete-btn { background:#dc2626; } 
    button.pdf-btn { background:#f97316; }
    button.print-btn { background:#059669; }
    button:disabled { background:#9ca3af; cursor: not-allowed; }
    .note { font-size:12px; color:#666; margin-top:8px; }
    
    table { 
        width:100%; 
        border-collapse: collapse; 
        table-layout: fixed; 
    }
    table th, table td { 
        border:1px solid #444; 
        padding: 4px 6px; 
        text-align:left; 
        vertical-align:top; 
        line-height: 1.4; 
    } 
    
    #pvTable td:nth-child(5) { 
        font-size: 9px; 
        line-height: 1.2;
    }

    .rows-input { 
        margin-top:8px; 
        border:1px solid #ddd; 
        padding:6px; 
        border-radius:6px; 
        background: #fcfcfc; 
    }
    
    .row-group { border: 1px solid #eee; padding: 8px; margin-bottom: 10px; border-radius: 4px; background: #fff; }
    .row-header { font-weight: bold; margin-bottom: 6px; font-size: 13px; display: flex; justify-content: space-between; align-items: center; background: #f9f9f9; padding: 4px; border-radius: 4px; }
    .row-detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-top: 6px; }
    .observation-fields { 
        border-top: 1px dashed #ddd; 
        padding-top: 8px; 
        margin-top: 8px; 
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        gap: 6px; 
    } 
    .report-search-section { border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 10px; }
    .search-area { display: flex; gap: 8px; margin-bottom: 8px; }
    .report-list-container { max-height: 150px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4ims: center; flex-wrap: wrap; }
    
    .inspection-codes-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 1fr; 
        gap: 5px;
        margin-top: 10px;
        margin-bottom: 10px;
    }
    .inspection-codes-grid > div {
        text-align: center;
        border: 1px solid #ccc;
        padding: 5px;
        font-size: 10px;
        line-height: 1;
        background: #fcfcfc;
    }
    
    .hide-inspection { display: none; } 
    
    /* --- NEW CSS for Collapsible Folders --- */
    .customer-group { margin-bottom: 10px; border: 1px solid #ddd; border-radius: 6px; overflow: hidden; }
    .customer-header { background: #f0f0f0; padding: 8px 10px; cursor: pointer; font-weight: bold; font-size: 14px; display: flex; justify-content: space-between; align-items: center; }
    .month-header { background: #fafafa; padding: 6px 15px; cursor: pointer; font-weight: 500; font-size: 13px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #eee; }
    .folder-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
    .folder-content.expanded { max-height: 1000px; /* Large value to allow expansion */ transition: max-height 0.5s ease-in; }
    .toggle-icon { transition: transform 0.3s; margin-left: 5px; }
    .toggle-icon.expanded { transform: rotate(90deg); }

    .report-list-item { padding: 8px 20px; cursor: pointer; border-bottom: 1px dotted #eee; display: flex; justify-content: space-between; align-items: center; }
    .report-list-item:hover { background: #f5f5f5; }
    .report-list-item.selected { background: #e0f2f1; font-weight: bold; border-left: 4px solid #009688; }
    
    /* NEW: Qty input grid */
    .qty-input-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 8px; }
    .qty-input-grid > div { flex: 1; }
    
    @media (max-width: 900px) {
        .container { flex-direction: column; }
        .form { width: 100%; max-width: none; height: auto; order: 1; }
        .preview-wrap { width: 100%; order: 2; align-items: stretch; }
        .preview { min-height: 200px; padding: 5px; box-shadow: none; overflow-x: auto; }
        .preview table { min-width: 1000px; } 
        .auth-bar { flex-direction: column; align-items: stretch; }
        .auth-controls { justify-content: center; margin-top: 8px; }
        .auth-bar input { width: calc(50% - 10px); margin: 5px; }
        .auth-bar button { width: auto; margin: 5px; }
        
        #homePanel { height: auto !important; }
        
        .qty-input-grid { grid-template-columns: 1fr; }
    }
    @media print {
        body * { visibility: hidden; }
        .preview, .preview * { visibility: visible; }
        .preview { 
            position: absolute; 
            left:0; 
            top:0; 
            box-shadow:none; 
            width: 210mm; 
            height: auto; 
            padding: 12mm; 
            margin: 0; 
            overflow: hidden; 
            font-size: 9.5px; 
        }
        .preview table { min-width: 100%; }
        .preview table th, .preview table td { 
            padding: 4px 5px; 
            line-height: 1.4; 
        } 
        #pvTable td:nth-child(5) { font-size: 9px; } 
    }
    
   

/* ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§µ‡§æ‡§≤‡•Ä ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§ï‡§æ ‡§°‡§ø‡§ú‡§æ‡§á‡§® */
#gatekeeperOverlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #0f172a; display: flex; align-items: center; 
    justify-content: center; z-index: 99999;
}
.gate-box {
    background: white; padding: 30px; border-radius: 15px; 
    text-align: center; width: 90%; max-width: 350px;
}
.gate-input {
    width: 100%; padding: 12px; margin: 15px 0; 
    border: 2px solid #e2e8f0; border-radius: 8px;
}
.gate-btn {
    width: 100%; padding: 12px; background: #2563eb; 
    color: white; border: none; border-radius: 8px; cursor: pointer;
}

  </style>
</head>
<body>
    
    <div id="gatekeeperOverlay">
    <div class="gate-box">
        <h2 style="color: #1e293b;">üîí Access Locked</h2>
        <input type="password" id="masterPassField" class="gate-input" placeholder="Enter Master Password">
        <button onclick="checkMasterPassword()" class="gate-btn">Unlock App</button>
        <p id="wrongPassMsg" style="color: red; display: none; margin-top: 10px;">‡§ó‡§≤‡§§ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°!</p>
    </div>
</div>
  
   <div id="appBody" style="display:none;"> 
       
<div id="mainAppWrapper">

    
  <div class="auth-bar">
    <div id="loggedOutUI" class="auth-controls">
        <span class="auth-status-text" id="authStatus" style="color: #dc2626;">Status: Logged Out (Cloud Disabled)</span>
        <input type="email" id="loginEmail" placeholder="Email" value="test@jobcard.com">
        <input type="password" id="loginPassword" placeholder="Password" value="password123">
        <button id="loginButton" style="background-color: #3f51b5; color: white;" onclick="handleAuthAction('signin')">Sign In</button>
        <button id="signUpButton" style="background-color: #059669; color: white;" onclick="handleAuthAction('signup')">Sign Up</button>
    </div>
    
    <div id="loggedInUI" class="auth-controls" style="display: none;">
        <span class="auth-status-text" id="userEmailDisplay" style="color: #059669;"></span>
        <button id="logoutButton" style="background-color: #f97316; color: white;" onclick="handleAuthAction('logout')">Log Out</button>
    </div>
  </div>
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px; flex-wrap: wrap;">
    <h1 style="font-size:18px;margin:0 0 5px 0;">Job Card / Route Card ‚Äî Cloud PWA System (Full Access)</h1>
    <div class="actions" style="width: auto; align-items: center; flex-wrap: wrap;">
      <button id="homeViewBtn" class="secondary" style="background:#5a67d8;">üè† Home / Job Folders</button> 
      <button id="formViewBtn" class="secondary" style="background:#2563eb; display:none;">üìù Go to Job Card Form</button> 
      <span id="currentReportId" style="font-size:14px; color:#666; margin-right: 15px;">Active ID: -- New --</span>
      <button id="downloadPdfBtn" class="pdf-btn">‚¨áÔ∏è Download PDF (Auto Height)</button>
      <button id="printBtn" class="print-btn">üñ®Ô∏è Print Job Card (Screen View)</button>
    </div>
  </div>

  <div class="container">
    
    <div id="homePanel" class="panel" style="width:100%; height:85vh; display: none; flex-direction: column; gap: 15px;">
        <h2 style="font-size: 20px; color:#10b981; margin-bottom: 0;">üìã Job Card Management Home</h2>
        <div style="display: flex; gap: 15px; flex-grow: 1;">
            
            <div style="flex: 1; border: 1px solid #ddd; padding: 10px; border-radius: 6px; background: #fffbe6; display: flex; flex-direction: column;">
                <h3 style="margin: 0 0 10px 0; color:#f59e0b;">üèÉ Running Jobs (Active)</h3>
                <div class="search-area" style="margin-bottom: 8px;">
                    <input id="runningSearch" type="text" placeholder="Search by Challan / Part / Customer" oninput="loadReportsList(this.value, 'Running')" />
                    <button onclick="loadReportsList(document.getElementById('runningSearch').value, 'Running')">üîç</button>
                </div>
                <div id="runningJobsContainer" class="report-list-container" style="max-height: none; flex-grow: 1; border: none; padding: 0;">
                    <div style="padding:10px; text-align:center; color:#666;">... Loading Running Jobs ...</div>
                </div>
                <div style="margin-top: 10px; text-align: center;">
                    <button id="newJobFromHome" style="background:#10b981;">‚ûï Create New Job Card</button>
                </div>
            </div>
            
            <div style="flex: 1; border: 1px solid #ddd; padding: 10px; border-radius: 6px; background: #f0fdf4; display: flex; flex-direction: column;">
                <h3 style="margin: 0 0 10px 0; color:#059669;">‚úÖ Completed Jobs (History)</h3>
                <div class="search-area" style="margin-bottom: 8px;">
                    <input id="completedSearch" type="text" placeholder="Search by Challan / Part / Customer" oninput="loadReportsList(this.value, 'Completed')" />
                    <button onclick="loadReportsList(document.getElementById('completedSearch').value, 'Completed')">üîç</button>
                </div>
                <div id="completedJobsContainer" class="report-list-container" style="max-height: none; flex-grow: 1; border: none; padding: 0;">
                    <div style="padding:10px; text-align:center; color:#666;">... Loading Completed Jobs ...</div>
                </div>
            </div>
        </div>
    </div>
    <div class="panel form" style="display: none;">
      
      <div class="report-search-section">
        <h2 style="font-size: 16px; text-align: left; margin-bottom: 8px; color:#2563eb;">Active Job Card</h2>
        
        <div style="display: none;"><label>Job Status</label><input id="statusField" type="text" value="Running" readonly></div>
        
        <div class="report-actions-bottom">
          <button id="newReportBtn" class="secondary" style="background:#10b981;">‚ûï New Job Card</button>
          <button id="saveReport" disabled>üíæ Save New Report</button>
          <button id="completeReportBtn" class="secondary" style="background:#059669;" disabled>‚úÖ Mark as Completed</button> 
          <button id="deleteReport" class="delete-btn" disabled>üóëÔ∏è Delete</button>
        </div>
        <div class="note" style="color: #f97316; font-weight: bold;">üîë Report saves using Customer/Part/Challan No.</div>
        <div class="note" style="color: #dc2626; font-weight: bold;">‚ö†Ô∏è This data will be saved to the Cloud (Firebase).</div>
      </div>
      
      <h2 style="margin-top:20px;">General Information</h2>
      <label>Customer Name
        <input id="customerName" type="text" placeholder="Customer name" value="Star Engineering" />
      </label>
      
      <div class="top-grid">
        <div class="qty-input-grid">
          <div><label>Order/Challan Qty<input id="orderQty" type="text" placeholder="Qty" value="1000" /></label></div>
          <div><label>Qty Unit
            <select id="orderQtyUnit">
                <option value="Nos" selected>Nos</option>
                <option value="Kg">Kg</option>
            </select>
          </label></div>
        </div>
        <div><label>Challan No/Date<input id="challan" type="text" placeholder="No / Date" value="CH/2508/01 | 01.09.2025" /></label></div>
      </div>
      <label>Part Desc / No<input id="partDesc" type="text" placeholder="Part description or no" value="LAC09170" /></label>
      <div class="top-grid">
        <div><label>Coating Spec (e.g. 2B, 1T)</label><input id="coatingSpec" type="text" placeholder="e.g. 1B,2B,1T" value="2 Base | 2 Top"/></div>
        <div>
          <label>**Paint**
            <select id="paint">
                <option value="Silver">Silver</option>
                <option value="Black" selected>Black</option>
            </select>
            <button id="updateOpsBtn" style="width:100%; margin-top:5px; padding: 8px;">Update Operations</button>
          </label>
        </div>
      </div>
      
      <label>**Batch No.**
        <input id="batchNo" type="text" placeholder="Batch number" value="250819" />
      </label>
      
      <h2 style="margin-top:20px;">Coating Batch Numbers & Paint Details</h2>
      <div class="inspection-codes-grid">
          <div id="silverInspDiv" class="hide-inspection"><label>Silver Paint Name</label><input id="silverInsp" type="text" placeholder="Silver Paint Name" value="Silver Paint" /></div>
          <div id="blackInspDiv"><label>Black Paint Name</label><input id="blackInsp" type="text" placeholder="Black Paint Name" value="Black Paint" /></div>
          <div><label>Base Coat Batch No.</label><input id="baseBatch" type="text" placeholder="Base Coat Batch No" value="" /></div>
          <div><label>Top Coat Batch No.</label><input id="topBatch" type="text" placeholder="Top Coat Batch No" value="" /></div>
      </div>
      
      <div class="top-grid" style="display:none; margin-top: -5px;">
        <div><label>Pre-Heating Temp (Coating)</label><select id="preHeatingTemp"></select></div>
        <div><label>Main Heating/Baking Temp (Coating)</label><select id="mainHeatingTemp"></select></div>
      </div>
      
      <h2 style="margin-top:20px;">Operation Details (Input Fields)</h2>
      <div class="rows-input"><div id="rowsInput"></div></div>
      <div class="note">Fill different values in the **Observation** fields under each operation.</div>
      <h2 style="margin-top:20px;">Signatures & Notes</h2>
      
      <label>Verified By
        <select id="verifiedBy">
            </select>
      </label>
      
      <label>Approved By
        <select id="approvedBy">
            </select>
      </label>
      
      <label>Notes<input id="notes" type="text" placeholder="Notes / Remark" value="P- Pointage, V- Viscosity, T- Temp, S-speed, A-Adhesion." /></label>
      <div class="actions">
        <button id="applyBtn">Apply to Preview</button>
        <button id="clearBtn" class="secondary">Clear Form</button>
      </div>
    </div>

    <div class="preview-wrap" style="display: none;">
      <div class="panel" style="width:100%; padding:8px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div class="small">ISO 9001:2015</div>
        </div>
      </div>
      <div id="preview" class="preview panel">
        <h2>JOB CARD / ROUTE CARD</h2>
        
        <table style="margin-bottom:8px; table-layout: fixed; width:100%;">
            <tr>
                <td style="width:33.3%; text-align:center;">Format No: **WT/PDR/11**</td>
                <td style="width:33.3%; text-align:center;">REV. NO: **01**</td>
                <td style="width:33.3%; text-align:center;">REV. DATE: **01.09.2025**</td>
            </tr>
        </table>
        
        <table style="margin-bottom:8px; table-layout: auto;">
          <tr><td style="width:18%">Customer Name</td><td id="pvCustomer" style="width:32%"></td><td style="width:18%">Order/Challan Qty</td><td id="pvQty" style="width:32%"></td></tr>
          <tr><td>Customer Challan No/Date</td><td id="pvChallan" colspan="3"></td></tr>
          <tr><td>Part Desc/No</td><td id="pvPart"></td><td>**Batch No.**</td><td id="pvBatchNo"></td></tr>
        </table>

        <table style="margin-bottom:8px; table-layout: auto;">
            <thead>
                <tr>
                    <td style="width:25%">COATING SPECIFICATION</td>
                    <th id="pvInspHeader" style="width:17%; text-align:center;">Paint</th>
                    <th style="width:29%; text-align:center;">BASE COAT BATCH NO.</th>
                    <th style="width:29%; text-align:center;">TOP COAT BATCH NO.</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td id="pvCoating" style="text-align:center; font-weight:bold;"></td>
                    <td id="pvInspValue" style="text-align:center;"></td>
                    <td id="pvBaseBatch" style="text-align:center;"></td>
                    <td id="pvTopBatch" style="text-align:center;"></td>
                </tr>
            </tbody>
        </table>
        
        <table id="pvTable">
          <thead>
            <tr>
              <th style="width:4%">Sr No</th>
              <th style="width:10%">Date/Shift</th>
              <th style="width:12%">Operation</th>
              <th style="width:28%">Specifications</th> 
              <th style="width:18%">Observation</th>
              <th style="width:7%">From Time</th>
              <th style="width:7%">To Time</th>
              <th style="width:7%">Inspection OK/NOK</th>
              <th style="width:16%">Operator/Supervisor/QA Signature</th> </tr>
          </thead>
          <tbody id="pvRows"></tbody>
        </table>
        
        <div style="display:flex;justify-content:space-between;margin-top:6px;">
          <div>Verified By: <span id="pvVerified"></span></div>
          <div>Approved By: <span id="pvApproved"></span></div>
        </div>
        
        <div style="margin-top:6px;">
            Note - <span id="pvNotes"></span>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <script>
    let currentActiveReportId = null; 
    
    // UPDATED: Added orderQtyUnit to jobFields
    const jobFields = ['customerName', 'orderQty', 'orderQtyUnit', 'challan','partDesc','coatingSpec','paint','batchNo', 'verifiedBy','approvedBy','notes', 'silverInsp', 'blackInsp', 'baseBatch', 'topBatch'];
    
    // --- UPDATED: Supervisor/Signature List (Operator/QA/Supervisor) ---
    // VINAYAK PAWAR IS REMOVED from this list per request
    const SUPERVISORS = [
        "N/A", // Now the default selected option
        "MANOJ SHAH", 
        "SURAJ KUMAR", 
        "MOHAMMAD ANSARI", 
        "SAKSHI CHAVHAN", 
        "KOMAL TAYADE",
        "ABHIJEET DHOKRAT",
        "BALAJI KATURE", 
        "SACHIN WALTURE", 
        "VISHNU SABLE", 
        "VINOD SELOKAR"
    ];

    // --- NEW: Verified/Approved By List (Includes Vinayak Pawar) ---
    const VERIFIED_APPROVED_BY = [
        "N/A",
        "SACHIN WALTURE",
        "ABHIJEET DHOKRAT",
        "VINAYAK PAWAR" // Vinayak Pawar is only here
    ];
    // --- END UPDATED LISTS ---

    // --- TEMPERATURE SPECIFICATIONS (Ranges for Select Options) ---
    const TEMPERATURE_SPECS = {
        // Geopert pre Heating 150 degree change krdo. <-- REQUEST 1 IMPLEMENTED HERE
        Geopert: { pre: ["150¬∞C"], main: ["360¬∞C"] }, 
        Aquazinc: { pre: ["N/A"], main: ["180¬∞C", "200¬∞C"] }, 
        Zintek: { pre: ["220¬∞C"], main: ["280¬∞C"] },
        // Techdip temp based on user's note
        Techdip: { pre: ["220¬∞C"], main: ["260¬∞C"] }, 
        Drying: { pre: ["100¬∞C", "150¬∞C", "220¬∞C"], main: []}
    };
    
    // --- NEW/UPDATED: Speed Specification Options ---
    const SPEED_OPTIONS = [
        { value: "3.38 Hz", label: "3.38 Hz" },
        { value: "5 Hz", label: "5 Hz" },
        { value: "30 min-box oven", label: "30 min-box oven" } // Added 30min-box oven
    ];
    
    // --- NEW: Machine No. Options ---
    const MACHINE_OPTIONS = [
        { value: "N/A", label: "-- Select Machine --" },
        { value: "Machine 1 (300kg)", label: "Machine 1 (300kg)" },
        { value: "Machine 2 (100kg)", label: "Machine 2 (100kg)" },
        { value: "Machine 3 (40kg)", label: "Machine 3 (40kg)" }
    ];

    /**
     * Helper to get Speed options.
     * @returns {Array} Array of speed options.
     */
    function getSpeedOptions() {
        return SPEED_OPTIONS;
    }
    
     /**
     * Helper to get Machine options.
     * @returns {Array} Array of machine options.
     */
    function getMachineOptions() {
        return MACHINE_OPTIONS;
    }

    // --- UPDATED: SPECIFICATIONS (Including new Machine No. and Cycle Time) ---
    const SPECIFICATIONS = {
        "Incoming Inspection": "Dent free, no heavy rust or oil, gauge fitment",
        "Alkaline Cleaning": "45-65 gms/litre",
        "Drying": "Temp (100-220¬∞C) & Time(15-30 mins)", 
        // üö® MODIFIED: Shot Blasting specification updated to include Machine No., Time, and Cycle Time
        "Shot Blasting": "Machine No., Time (15 to 30 mins) & Cycle Time (min)", 
        "Packing & Dispatch": "Qty (value), Match Check", 
        "Spare Operation": "N/A",
        "Final Inspection_Silver": "No uncover coating, no excess paint in thread & socket, Adhesion test should be clean. Silver Thickness range - 6 to 12 microns",
        "Final Inspection_Black": "No uncover coating, no excess paint in thread & socket, Adhesion test should be clean. Black Thickness range - 8 to 16 microns",
        
        // --- UPDATED VISCOSITY: Geopert 60-90 sec ---
        // Note: PHT is 150¬∞C as per Request 1
        "Silver_Base Coat -1 & Curing": "Geopert: Viscosity - 60-90 sec, speed - 5 Hz., Pre-Heating Temp (150¬∞C), Main Heating Temp (360¬∞C)",
        "Silver_Base Coat -2 & Curing": "Geopert: Viscosity - 60-90 sec, speed - 5 Hz., Pre-Heating Temp (150¬∞C), Main Heating Temp (360¬∞C)",
        "Silver_Top Coat -1 & Curing": "Aquazinc: Viscosity - 28-38 sec, time - 30 mins., Baking Temp (180¬∞C/200¬∞C)", 
        
        // --- UPDATED VISCOSITY: Zintek 33-38 sec ---
        "Black_Base Coat -1 & Curing": "Zintek: Viscosity - 33-38 sec, speed - 3.38 Hz., Pre-Heating Temp (220¬∞C), Main Heating Temp (280¬∞C)",
        "Black_Base Coat -2 & Curing": "Zintek: Viscosity - 33-38 sec, speed - 3.38 Hz., Pre-Heating Temp (220¬∞C), Main Heating Temp (280¬∞C)",
        "Black_Top Coat -1 & Curing": "Techdip: Viscosity - 42-50 sec, speed - 3.38 Hz., Pre-Heating Temp (220¬∞C), Main Heating Temp (260¬∞C)",
        "Black_Top Coat -2 & Curing": "Techdip: Viscosity - 42-50 sec, speed - 3.38 Hz., Pre-Heating Temp (220¬∞C), Main Heating Temp (260¬∞C)",
    };
    
    // --- UPDATED: PARAMETERS (Added Machine No. select and Cycle Time input) ---
    const PARAMETERS = {
        "Incoming Inspection": { labels: ["Observation"], units: [""] }, 
        "Alkaline Cleaning": { labels: ["Pointage"], units: ["gms/litre"] }, 
        "Drying": { labels: ["Temp (Select)", "Time"], units: ["¬∞C", "min"], useTempSelect: true, tempType: 'Drying' }, 
        // üö® MODIFIED: Machine No. is now a select. Added Cycle Time Input.
        "Shot Blasting": { labels: ["Machine No. (Select)", "Time", "Cycle Time"], units: ["", "min", "min"], usesCycleTime: true },
        
        // MODIFIED: Speed is now (Select)
        "Base Coat -1 & Curing": { labels: ["Viscosity", "Speed (Select)", "Pre-Heating Temp (Select)", "Main Heating Temp (Select)"], units: ["sec", "Hz", "¬∞C", "¬∞C"], isCoating: true, tempType: 'Base' },
        "Base Coat -2 & Curing": { labels: ["Viscosity", "Speed (Select)", "Pre-Heating Temp (Select)", "Main Heating Temp (Select)"], units: ["sec", "Hz", "¬∞C", "¬∞C"], isCoating: true, tempType: 'Base' },
        
        // Top Coat speed remains input/time-speed
        "Top Coat -1 & Curing": { labels: ["Viscosity", "Time/Speed", "Baking Temp (Select)"], units: ["sec", "min/Hz", "¬∞C"], isCoating: true, tempType: 'Top' },
        "Top Coat -2 & Curing": { labels: ["Viscosity", "Time/Speed", "Pre-Heating Temp (Select)", "Main Heating Temp (Select)"], units: ["sec", "min/Hz", "¬∞C", "¬∞C"], isCoating: true, tempType: 'Top' },
        
        "Final Inspection": { labels: ["Thickness", "Adhesion"], units: ["microns", ""] },
        "Packing & Dispatch": { labels: ["Dispatch Qty", "Qty Unit", "Match"], units: ["", "", ""], isQtySelect: true },
        "Spare Operation": { labels: ["N/A"], units: [""] },
    };
    
    // --- BASE_OPERATIONS (Kept as structure, logic in getCurrentPredefinedOperations) ---
    const BASE_OPERATIONS = [
      { op: "Incoming Inspection", color: 'N/A', order: 1 },
      { op: "Alkaline Cleaning", color: 'N/A', order: 2 },
      { op: "Drying", color: 'N/A', order: 3 },
      { op: "Shot Blasting", color: 'N/A', order: 4 },
      // Coating Steps are inserted here (order 5, 6, 7, 8)
      { op: "Final Inspection", color: 'N/A', order: 9 },
      { op: "Packing & Dispatch", color: 'N/A', order: 10 },
      { op: "Spare Operation", color: 'N/A', order: 11 }, 
      { op: "Spare Operation", color: 'N/A', order: 12 }, 
    ];
    
    // --- getCurrentPredefinedOperations (MODIFIED: Ensures correct operation list size) ---
    function getCurrentPredefinedOperations() {
        const paintSelect = document.getElementById('paint');
        const paintType = paintSelect.value;
        // Start with a copy of BASE_OPERATIONS
        const ops = JSON.parse(JSON.stringify(BASE_OPERATIONS.slice(0, 4))); 
        
        const coatingSteps = [];

        const silverDiv = document.getElementById('silverInspDiv');
        const blackDiv = document.getElementById('blackInspDiv');
        
        silverDiv.classList.add('hide-inspection');
        blackDiv.classList.add('hide-inspection');
        
        if (paintType === 'Black') {
            document.getElementById('coatingSpec').value = "2 Base | 2 Top";
            blackDiv.classList.remove('hide-inspection');
            coatingSteps.push(
                { op: "Base Coat -1 & Curing", color: 'Black', paintName: 'Zintek' },
                { op: "Base Coat -2 & Curing", color: 'Black', paintName: 'Zintek' },
                { op: "Top Coat -1 & Curing", color: 'Black', paintName: 'Techdip' }, 
                { op: "Top Coat -2 & Curing", color: 'Black', paintName: 'Techdip' } 
            );
             // 4 pre-steps + 4 coating = 8
        } else { // Silver (Default)
             document.getElementById('coatingSpec').value = "2 Base | 1 Top";
             silverDiv.classList.remove('hide-inspection');
             coatingSteps.push(
                { op: "Base Coat -1 & Curing", color: 'Silver', paintName: 'Geopert' },
                { op: "Base Coat -2 & Curing", color: 'Silver', paintName: 'Geopert' },
                { op: "Top Coat -1 & Curing", color: 'Silver', paintName: 'Aquazinc' }
            );
            // 4 pre-steps + 3 coating = 7
        }

        // Insert coating steps
        ops.push(...coatingSteps);

        // Add Final Inspection and Packing/Dispatch
        ops.push(
            { op: "Final Inspection", color: 'N/A', order: ops.length + 1 },
            { op: "Packing & Dispatch", color: 'N/A', order: ops.length + 2 }
        );

        // The returned array will have 9 items for Silver, and 10 for Black.
        return ops; 
    }

    /**
     * Helper to get Temperature options for a specific step.
     * @param {string} opName - The name of the operation.
     * @param {string} paintType - 'Silver' or 'Black'.
     * @returns {object} {pre: [], main: []}
     */
    function getTemperatureOptions(opName, paintType) {
        let preTemps = [];
        let mainTemps = [];
        
        if (opName === "Drying") {
            preTemps = TEMPERATURE_SPECS.Drying.pre;
            mainTemps = [];
            return { pre: preTemps, main: mainTemps };
        }
        
        const operations = getCurrentPredefinedOperations();
        const opConfig = operations.find(op => op.op === opName);
        const paintKey = opConfig ? opConfig.paintName : null;
        
        if (paintKey && TEMPERATURE_SPECS[paintKey]) {
            const spec = TEMPERATURE_SPECS[paintKey];
            
            if (opName.includes('Top Coat')) { 
                if (paintType === 'Silver') { // Aquazinc
                    if (opName === 'Top Coat -1 & Curing') { 
                        mainTemps = spec.main; // Only Baking Temp
                    }
                } else if (paintType === 'Black') { // Techdip
                     preTemps = spec.pre;
                     mainTemps = spec.main;
                }
            } else if (opName.includes('Base Coat')) { 
                preTemps = spec.pre;
                mainTemps = spec.main;
            }
            
            // Aquazinc (Silver Top Coat) has N/A for pre-heating
            if (paintKey === 'Aquazinc' && opName.includes('Top Coat')) {
                 preTemps = []; // Ensure no pre-heating field for Aquazinc
            }
        }
        
        return { pre: preTemps, main: mainTemps };
    }
    
    // --- initSignatureSelectors (NEW/MODIFIED: To populate the two separate lists) ---
    function initSignatureSelectors() {
        const verifiedBySelect = document.getElementById('verifiedBy');
        const approvedBySelect = document.getElementById('approvedBy');
        
        const generateOptions = (list, selectedValue = 'N/A') => {
            let optionsHTML = list.map(name => 
                `<option value="${name}" ${selectedValue === name ? 'selected' : ''}>${name}</option>`
            ).join('');
            return optionsHTML;
        };

        verifiedBySelect.innerHTML = generateOptions(VERIFIED_APPROVED_BY, verifiedBySelect.value);
        approvedBySelect.innerHTML = generateOptions(VERIFIED_APPROVED_BY, approvedBySelect.value);
    }

    // --- updateRowInputs (Generates form inputs including select for Temp, Qty Unit, Shift, TIME, Speed, and now Machine No.) ---
    function updateRowInputs(savedRows = []) {
        
        const predefinedOperations = getCurrentPredefinedOperations();
        const rowsInputContainer = document.getElementById('rowsInput');
        rowsInputContainer.innerHTML = ''; 
        const paintType = document.getElementById('paint').value;
        
        const mapSavedData = (rows) => {
            const dataMap = {};
            rows.forEach(r => {
                const opParams = PARAMETERS[r.operation] || { labels: [], units: [] };
                
                // IMPORTANT: Cycle Time is no longer appended to the observation string, 
                // but we need to remove it from old saved data if it exists.
                let observationString = r.observation || '';
                let cycleTimeValueFromObs = '';
                const parts = observationString.split(';').map(v => v.trim());
                const cycleTimeIndex = parts.findIndex(p => p.startsWith('Cycle Time: '));
                if (cycleTimeIndex !== -1) {
                    cycleTimeValueFromObs = parts[cycleTimeIndex].replace('Cycle Time: ', '');
                    parts.splice(cycleTimeIndex, 1);
                    observationString = parts.join('; ');
                }
                
                const values = observationString.split(';').map(v => v.trim()); 
                const obsValues = {};
                
                // --- Logic to correctly map saved values to data-param keys ---
                let valueIndex = 0;
                opParams.labels.forEach((label) => {
                    let paramKey = '';
                    if (label.includes('Pre-Heating Temp')) paramKey = 'PreHeatingTemp';
                    else if (label.includes('Main Heating Temp')) paramKey = 'MainHeatingTemp';
                    else if (label.includes('Baking Temp')) paramKey = 'BakingTemp';
                    else if (label.includes('Temp')) paramKey = 'Temp';
                    else if (label.includes('Viscosity')) paramKey = 'Viscosity';
                    else if (label.includes('Time/Speed')) paramKey = 'TimeSpeed';
                    else if (label.includes('Speed')) paramKey = 'Speed'; // Catches both "Speed" and "Speed (Select)"
                    else if (label.includes('Pointage')) paramKey = 'Pointage';
                    else if (label.includes('Thickness')) paramKey = 'Thickness';
                    else if (label.includes('Adhesion')) paramKey = 'Adhesion';
                    else if (label.includes('Dispatch Qty')) paramKey = 'QtyValue'; 
                    else if (label.includes('Qty Unit')) paramKey = 'QtyUnit';
                    else if (label.includes('Match')) paramKey = 'Match';
                    else if (label.includes('Observation')) paramKey = 'Observation';
                    // üö® NEW: Machine No.
                    else if (label.includes('Machine No.')) paramKey = 'MachineNo';
                    // üö® NEW: Cycle Time (must be checked after other fields in PARAMETERS)
                    else if (label.includes('Cycle Time')) paramKey = 'CycleTime';


                    if (paramKey && values[valueIndex] !== undefined && paramKey !== 'CycleTime') {
                        obsValues[paramKey] = values[valueIndex] || '';
                        valueIndex++;
                    } else if (paramKey === 'CycleTime') {
                        // For Cycle Time, use the separate saved field first, then fallback to old observation data
                        obsValues[paramKey] = r.cycleTime || cycleTimeValueFromObs; 
                    }

                });
                // --- End Logic ---
                
                dataMap[r.operation] = { 
                    ...r, 
                    obsValues, 
                    cycleTime: r.cycleTime || cycleTimeValueFromObs, // Store Cycle Time separately
                    inspectionStatus: r.inspectionStatus || 'N/A',
                    operatorChecked: r.operatorChecked || '', 
                    supervisorSign: r.supervisorSign || 'N/A'
                }; 
            });
            return dataMap;
        };

        const savedDataMap = mapSavedData(savedRows);
        
        predefinedOperations.forEach((opConfig, index) => {
            const srCount = index + 1;
            const opName = opConfig.op;
            const opParams = PARAMETERS[opName];
            
            const savedData = savedDataMap[opName] || { obsValues: {}, cycleTime: '', inspectionStatus: 'N/A', operatorChecked: '', supervisorSign: 'N/A' }; // Set default sign to N/A
            
            const div = document.createElement('div');
            div.dataset.sr = srCount;
            div.dataset.operation = opName;
            div.className = 'row-group';
            
            let obsFieldsHTML = '';
            
            const specKey = opName.includes('Coat') ? `${paintType}_${opName}` : (opName === 'Final Inspection' ? `${paintType}_${opName}` : opName);
            const specification = SPECIFICATIONS[specKey] || opName;

            opParams.labels.forEach((label) => {
                if (label !== "N/A" && label.trim().length > 0) {
                    const unit = ''; 
                    // Determine the unique parameter key
                    let paramKey = '';
                    const isSelectField = label.includes('(Select)') && !label.includes('Speed') && !label.includes('Machine No.'); 
                    const isSpeedSelect = label.includes('Speed (Select)');
                    const isMachineSelect = label.includes('Machine No. (Select)'); // NEW check for machine
                    const isQtyUnit = label.includes('Qty Unit');
                    const isCycleTimeInput = label.includes('Cycle Time'); // NEW check for cycle time input
                    
                    if (label.includes('Pre-Heating Temp')) paramKey = 'PreHeatingTemp';
                    else if (label.includes('Main Heating Temp')) paramKey = 'MainHeatingTemp';
                    else if (label.includes('Baking Temp')) paramKey = 'BakingTemp';
                    else if (label.includes('Temp') && !label.includes('Heating')) paramKey = 'Temp';
                    else if (label.includes('Viscosity')) paramKey = 'Viscosity';
                    else if (label.includes('Time/Speed')) paramKey = 'TimeSpeed';
                    else if (label.includes('Speed') && !label.includes('Time/Speed')) paramKey = 'Speed';
                    else if (label.includes('Pointage')) paramKey = 'Pointage';
                    else if (label.includes('Thickness')) paramKey = 'Thickness';
                    else if (label.includes('Adhesion')) paramKey = 'Adhesion';
                    else if (label.includes('Dispatch Qty')) paramKey = 'QtyValue'; 
                    else if (label.includes('Qty Unit')) paramKey = 'QtyUnit';
                    else if (label.includes('Match')) paramKey = 'Match';
                    else if (label.includes('Observation')) paramKey = 'Observation';
                    // üö® NEW: Machine No.
                    else if (label.includes('Machine No.')) paramKey = 'MachineNo';
                    // üö® NEW: Cycle Time
                    else if (label.includes('Cycle Time')) paramKey = 'CycleTime';


                    if (!paramKey) return; // Skip if no key is defined
                    
                    const placeholder = `${label.replace('(Select)', '').trim()}`;
                    
                    // Determine saved value: CycleTime has its own key on savedData, others are in obsValues
                    const savedValue = (paramKey === 'CycleTime') ? savedData.cycleTime : (savedData.obsValues[paramKey] || '');
                    
                    if (isSelectField) {
                        const tempOptions = getTemperatureOptions(opName, paintType);
                        
                        let options = [];
                        if (paramKey === 'PreHeatingTemp' || paramKey === 'Temp') {
                            options = tempOptions.pre;
                        } else if (paramKey === 'MainHeatingTemp' || paramKey === 'BakingTemp') {
                            options = tempOptions.main;
                        }
                        
                        if (options.length === 0 && (paramKey === 'PreHeatingTemp')) {
                            return; 
                        }
                        
                        let selectOptionsHTML = `<option value="">-- Select ${label.replace('(Select)', '').trim()} --</option>`;
                        options.forEach(temp => {
                            const selected = (savedValue === temp) ? 'selected' : '';
                            selectOptionsHTML += `<option value="${temp}" ${selected}>${temp}</option>`;
                        });

                        obsFieldsHTML += `
                            <div>
                                <label>${placeholder}</label>
                                <select data-field="obsParam" data-param="${paramKey}">
                                    ${selectOptionsHTML}
                                </select>
                            </div>
                        `;
                    } else if (isQtyUnit) {
                        const units = ["Nos", "Kg"];
                         let selectOptionsHTML = `<option value="">-- Select Unit --</option>`;
                        units.forEach(u => {
                            const selected = (savedValue === u) ? 'selected' : '';
                            selectOptionsHTML += `<option value="${u}" ${selected}>${u}</option>`;
                        });
                        
                        obsFieldsHTML += `
                            <div>
                                <label>${placeholder}</label>
                                <select data-field="obsParam" data-param="${paramKey}">
                                    ${selectOptionsHTML}
                                </select>
                            </div>
                        `;
                    } else if (isSpeedSelect) { 
                        const speedOptions = getSpeedOptions();
                        
                        let selectOptionsHTML = `<option value="">-- Select Speed --</option>`;
                        speedOptions.forEach(s => {
                            const selected = (savedValue === s.value) ? 'selected' : '';
                            selectOptionsHTML += `<option value="${s.value}" ${selected}>${s.label}</option>`;
                        });

                        obsFieldsHTML += `
                            <div>
                                <label>${placeholder}</label>
                                <select data-field="obsParam" data-param="${paramKey}">
                                    ${selectOptionsHTML}
                                </select>
                            </div>
                        `;
                    } else if (isMachineSelect) { // --- NEW: Machine Select Logic ---
                        const machineOptions = getMachineOptions();
                        
                        let selectOptionsHTML = ``;
                        machineOptions.forEach(m => {
                            const selected = (savedValue === m.value) ? 'selected' : '';
                            selectOptionsHTML += `<option value="${m.value}" ${selected}>${m.label}</option>`;
                        });

                        obsFieldsHTML += `
                            <div>
                                <label>${placeholder}</label>
                                <select data-field="obsParam" data-param="${paramKey}">
                                    ${selectOptionsHTML}
                                </select>
                            </div>
                        `;
                    } else if (isCycleTimeInput) { // --- NEW: Cycle Time Input Logic ---
                         obsFieldsHTML += `
                            <div>
                                <label>${placeholder} (min)</label>
                                <input data-field="cycleTimeInput" type="text" placeholder="${placeholder} in minutes" value="${savedValue}" />
                            </div>
                        `;
                    } else {
                         obsFieldsHTML += `
                            <div>
                                <label>${placeholder}</label>
                                <input data-field="obsParam" data-param="${paramKey}" type="text" placeholder="${placeholder}" value="${savedValue}" />
                            </div>
                        `;
                    }
                }
            });
            
            // Adjust grid layout if only one field (Observation) remains
            const obsFieldsContainerClass = opName === 'Incoming Inspection' ? 'observation-fields' : 'observation-fields';
            const obsFieldsStyle = opName === 'Incoming Inspection' ? 'style="grid-template-columns: 1fr;"' : '';
            
            
            obsFieldsHTML += `
                <div>
                    <label>Inspection OK/NOK</label>
                    <select data-field="inspectionStatus">
                        <option value="N/A" ${savedData.inspectionStatus === 'N/A' ? 'selected' : ''}>N/A</option>
                        <option value="OK" ${savedData.inspectionStatus === 'OK' ? 'selected' : ''}>OK</option>
                        <option value="NOK" ${savedData.inspectionStatus === 'NOK' ? 'selected' : ''}>NOK</option>
                    </select>
                </div>
            `;
            
            // --- UPDATED: Use SUPERVISORS list which excludes Vinayak Pawar ---
            let supervisorOptionsHTML = SUPERVISORS.map(name => 
                `<option value="${name}" ${savedData.supervisorSign === name ? 'selected' : ''}>${name}</option>`
            ).join('');
            // --- END UPDATED ---

            
            div.innerHTML = `
                <div class="row-header">
                    <span>${srCount}. ${opName}</span>
                    <span>Spec: ${specification.substring(0, 40) + (specification.length > 40 ? '...' : '')}</span>
                </div>
                <div class="row-detail-grid">
                    <div>
                        <label>Date (Calendar)</label>
                        <input data-field="dateShift" type="date" value="${savedData.dateShift || ''}" />
                    </div>
                    <div>
                        <label>Shift</label>
                        <select data-field="shiftTime">
                            <option value="">-- Select Shift --</option>
                            <option value="1st" ${savedData.shiftTime === '1st' ? 'selected' : ''}>1st</option>
                            <option value="2nd" ${savedData.shiftTime === '2nd' ? 'selected' : ''}>2nd</option>
                            <option value="3rd" ${savedData.shiftTime === '3rd' ? 'selected' : ''}>3rd</option>
                        </select>
                    </div>
                </div>
                <div class="row-detail-grid">
                    <div><label>From Time</label><input data-field="fromTime" type="time" value="${savedData.fromTime || ''}" /></div>
                    <div><label>To Time</label><input data-field="toTime" type="time" value="${savedData.toTime || ''}" /></div>
                </div>

                <div class="${obsFieldsContainerClass}" ${obsFieldsStyle}>
                    ${obsFieldsHTML}
                </div>
                
                <div class="operator-supervisor-grid">
                    <div>
                        <label>Signature Input (Operator/Supervisor/QA)</label>
                        <select data-field="supervisorSign">
                            ${supervisorOptionsHTML}
                        </select>
                    </div>
                </div>
            `;
            
            div.querySelectorAll('input, select').forEach(inp => { 
                inp.addEventListener('change', applyPreview);
                inp.addEventListener('input', applyPreview); 
            });
            
            // üö® NEW CODE FOR COATING LOCK: Add event listeners to coating operations (Sr No 5 and above)
            if (srCount >= 5) {
                div.addEventListener('click', (e) => {
                    // Prevent default behavior if the click is directly on the group, not just an input/select
                    if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT' && e.target.tagName !== 'BUTTON') {
                        if (!handleCoatingLock(srCount, div)) {
                            e.preventDefault(); 
                            e.stopPropagation();
                        }
                    }
                });
                
                // Add focus listener for all inner elements to trigger the lock check
                div.querySelectorAll('input, select, button').forEach(el => {
                    el.addEventListener('focus', (e) => {
                         if (!handleCoatingLock(srCount, div)) {
                            e.preventDefault();
                            // If focus is prevented, try to redirect focus to the batch input later
                            setTimeout(() => {
                                handleCoatingLock(srCount, div); // Will redirect focus
                            }, 0);
                        }
                    });
                });
            }
            // üö® END NEW CODE
            
            rowsInputContainer.appendChild(div);
        });
        
        applyPreview(); 
        handleOperationFieldDisabling(); // **NEW CALL**: Disable/enable fields based on batch numbers
    }
    
    // START: NEW FUNCTION FOR BATCH NUMBER VALIDATION (REQUEST 2 - PART 1)
    window.handleBatchNoValidation = function() {
        const batchNoInput = document.getElementById('batchNo');
        const baseBatchInput = document.getElementById('baseBatch');
        const topBatchInput = document.getElementById('topBatch');
        
        const isUserLoggedIn = window.auth.currentUser !== null;
        
        // Check if the main Batch No. field is filled
        const isBatchNoFilled = batchNoInput.value.trim().length > 0;

        // Base/Top Batch inputs are only active if logged in AND main Batch No. is filled
        baseBatchInput.disabled = !(isUserLoggedIn && isBatchNoFilled);
        topBatchInput.disabled = !(isUserLoggedIn && isBatchNoFilled);
        
        // If the main batch no is empty, ensure sub-batch fields are blank/empty
        if (!isBatchNoFilled) {
            baseBatchInput.value = '';
            topBatchInput.value = '';
        }
        
        // Call the new operation disabling function
        handleOperationFieldDisabling();
        
        // Update preview after validation
        applyPreview(); 
    }
    // END: NEW FUNCTION FOR BATCH NUMBER VALIDATION

    // START: NEW FUNCTION FOR OPERATION FIELD DISABLING (REQUEST 2 - PART 2)
    function handleOperationFieldDisabling() {
        const isUserLoggedIn = window.auth.currentUser !== null;
        if (!isUserLoggedIn) return; // Skip if user is logged out (updateActionButtons handles overall disabling)

        const baseBatchFilled = document.getElementById('baseBatch').value.trim().length > 0;
        const topBatchFilled = document.getElementById('topBatch').value.trim().length > 0;
        
        // Coating operations are enabled ONLY if both Base and Top batches are filled
        const shouldDisableCoatingOps = !(baseBatchFilled && topBatchFilled);

        document.getElementById('rowsInput').querySelectorAll('.row-group').forEach((group, index) => {
            const srCount = index + 1;
            
            // Coating operations start from Sr No 5 onwards
            // Note: Coating steps can vary (Silver=3, Black=4), but all start at 5
            if (srCount >= 5) { 
                group.querySelectorAll('input, select').forEach(input => {
                    // Only disable if the operation is currently enabled (i.e., user is logged in)
                    if (isUserLoggedIn) {
                         input.disabled = shouldDisableCoatingOps;
                    }
                    
                    // Clear the fields if they are disabled to prevent filling data accidentally
                    if (shouldDisableCoatingOps) {
                        if (input.type === 'text' || input.type === 'date' || input.type === 'time') {
                            input.value = '';
                        } else if (input.tagName === 'SELECT' && input.dataset.field !== 'inspectionStatus' && input.dataset.field !== 'supervisorSign') {
                            // Only reset time/shift/temp/speed selects, not OK/NOK or Signature
                            input.selectedIndex = 0; 
                        }
                    }
                });
            } else {
                 // Sr 1 to 4 (Pre-Operations) should remain enabled as long as the user is logged in
                 // Disabling is handled by updateActionButtons (if !isLoggedIn)
            }
        });
        applyPreview();
    }
    // END: NEW FUNCTION FOR OPERATION FIELD DISABLING

    // START: NEW FUNCTION FOR BATCH NO. POPUP/LOCK
    function handleCoatingLock(srCount, operationDiv) {
        // This is only triggered for Sr No 5 and above
        if (srCount < 5) return true; 

        const isUserLoggedIn = window.auth.currentUser !== null;
        if (!isUserLoggedIn) return true; 
        
        const baseBatchInput = document.getElementById('baseBatch');
        const topBatchInput = document.getElementById('topBatch');
        
        const baseBatchFilled = baseBatchInput.value.trim().length > 0;
        const topBatchFilled = topBatchInput.value.trim().length > 0;

        // If both batch numbers are filled, the operation is NOT locked
        if (baseBatchFilled && topBatchFilled) {
            return true;
        }

        // If locked, show the pop-up in English
        alert("‚ö†Ô∏è Please fill in both BASE COAT BATCH NO. and TOP COAT BATCH NO. to proceed with coating operations.");
        
        // Focus back on the empty batch number field
        if (!baseBatchFilled) {
            baseBatchInput.focus();
        } else if (!topBatchFilled) {
            topBatchInput.focus();
        } 
        
        return false; // Indicates the operation is locked/prevented
    }
    // END: NEW FUNCTION FOR BATCH NO. POPUP/LOCK

    // --- getFormData (REVISED: CycleTime is collected as a separate field on the row object) ---
    function getFormData() {
      const data = {};
      const relevantJobFields = ['customerName', 'orderQty', 'orderQtyUnit','challan','partDesc','coatingSpec','paint','batchNo', 'verifiedBy','approvedBy','notes', 'silverInsp', 'blackInsp', 'baseBatch', 'topBatch'];
      relevantJobFields.forEach(f=> data[f] = document.getElementById(f).value.trim());
      
      data.status = document.getElementById('statusField')?.value || 'Running'; 
      
      const cleanCustomer = data.customerName.replace(/[^a-zA-Z0-9]/g, '_').replace(/_{2,}/g, '_').trim();
      const cleanPart = data.partDesc.replace(/[^a-zA-Z0-9]/g, '_').replace(/_{2,}/g, '_').trim();
      const cleanChallan = data.challan.replace(/[^a-zA-Z0-9]/g, '_').replace(/_{2,}/g, '_').trim();
      
      data.uniqueId = currentActiveReportId; 
      
      if (!data.uniqueId || data.uniqueId.startsWith('NEW_')) {
          data.uniqueId = `${cleanCustomer.substring(0, 3)}_${cleanPart}_${cleanChallan}`;
          if(data.uniqueId.length < 5 || data.uniqueId.length > 50 || data.uniqueId.endsWith('__')) {
               data.uniqueId = `NEW_${Date.now()}`;
          }
          data.uniqueId = data.uniqueId.toUpperCase();
      }
      
      
      const rows = [];
      document.getElementById('rowsInput').querySelectorAll('.row-group').forEach((group, index)=>{
        const operation = group.dataset.operation || '';
        const opParams = PARAMETERS[operation];
        
        let observationValues = [];
        
        // Skip collecting data if the operation fields are disabled (i.e. if batch numbers are missing)
        const isCoatingOp = index + 1 >= 5;
        const isCoatingDisabled = isCoatingOp && group.querySelector('input, select')?.disabled;
        
        const dateShiftValue = group.querySelector('input[data-field="dateShift"]').value.trim();
        const shiftTimeValue = group.querySelector('select[data-field="shiftTime"]').value; 
        const fromTimeValue = group.querySelector('input[data-field="fromTime"]').value;
        const toTimeValue = group.querySelector('input[data-field="toTime"]').value;
        const inspectionStatus = group.querySelector('select[data-field="inspectionStatus"]').value;
        const supervisorSign = group.querySelector('select[data-field="supervisorSign"]').value;
        
        let cycleTimeValue = ''; // NEW: Separate variable for cycle time

        
        if (opParams && opParams.labels && !isCoatingDisabled) { // Only collect data if not disabled
            opParams.labels.forEach((label) => {
                if (label !== "N/A" && label.trim().length > 0) {
                    let paramKey = '';
                    
                    if (label.includes('Pre-Heating Temp')) paramKey = 'PreHeatingTemp';
                    else if (label.includes('Main Heating Temp')) paramKey = 'MainHeatingTemp';
                    else if (label.includes('Baking Temp')) paramKey = 'BakingTemp';
                    else if (label.includes('Temp') && !label.includes('Heating')) paramKey = 'Temp';
                    else if (label.includes('Viscosity')) paramKey = 'Viscosity';
                    else if (label.includes('Time/Speed')) paramKey = 'TimeSpeed';
                    else if (label.includes('Speed')) paramKey = 'Speed'; 
                    else if (label.includes('Pointage')) paramKey = 'Pointage';
                    else if (label.includes('Thickness')) paramKey = 'Thickness';
                    else if (label.includes('Adhesion')) paramKey = 'Adhesion';
                    else if (label.includes('Dispatch Qty')) paramKey = 'QtyValue'; 
                    else if (label.includes('Qty Unit')) paramKey = 'QtyUnit';
                    else if (label.includes('Match')) paramKey = 'Match';
                    else if (label.includes('Observation') && !label.includes('Qty')) paramKey = 'Observation';
                    // üö® NEW: Machine No.
                    else if (label.includes('Machine No.')) paramKey = 'MachineNo';
                    // üö® NEW: Cycle Time
                    else if (label.includes('Cycle Time')) paramKey = 'CycleTime';


                    if (!paramKey) return; 
                    
                    if (paramKey === 'CycleTime') {
                         const element = group.querySelector(`[data-field="cycleTimeInput"]`);
                         cycleTimeValue = element?.value.trim() || '';
                         return; // Do not push CycleTime to observationValues
                    }

                    const element = group.querySelector(`[data-field="obsParam"][data-param="${paramKey}"]`);
                    // Skip if PreHeatingTemp field doesn't exist (e.g. Aquazinc)
                    if (paramKey === 'PreHeatingTemp' && !element) return; 
                    
                    observationValues.push(element?.value.trim() || '');
                }
            });
        }

        let observation = isCoatingDisabled ? '' : observationValues.join('; ').trim();
        
        // Skip spare if empty AND isCoatingDisabled check is false (i.e., pre-ops only)
        if (operation.includes('Spare Operation') && observation.replace(/; /g, '').length === 0 && dateShiftValue === '' && shiftTimeValue === '') return;
        
        // Ensure coating ops have blank data if disabled, but still include the row to preserve structure
        if (isCoatingDisabled) {
             rows.push({
                sr: index + 1,
                dateShift: '',
                shiftTime: '', 
                observation: '', 
                fromTime: '',
                toTime: '',
                qty: '', 
                inspectionStatus: 'N/A', 
                operatorChecked: '', 
                supervisorSign: 'N/A', 
                operation: operation, 
                cycleTime: '' // NEW: Blank cycle time
            });
        } else {
             rows.push({
              sr: index + 1,
              dateShift: dateShiftValue,
              shiftTime: shiftTimeValue, // Now uses select value
              observation: observation, // No longer contains Cycle Time
              fromTime: fromTimeValue,
              toTime: toTimeValue,
              qty: '', 
              inspectionStatus: inspectionStatus, 
              operatorChecked: '', 
              supervisorSign: supervisorSign, 
              operation: operation, 
              cycleTime: cycleTimeValue // NEW: Store Cycle Time separately
            });
        }
      });
      data.rows = rows;
      
      return data;
    }

    // --- Utility Functions (setFormData and clearForm REVISIONS) ---

    function setFormData(data) {
        jobFields.forEach(f => {
            const el = document.getElementById(f);
            if (el && data[f] !== undefined) {
                 el.value = data[f] || ''; 
            }
        });
        
        const statusEl = document.getElementById('statusField');
        if (statusEl) {
            const currentStatus = data.status || 'Running';
            statusEl.value = currentStatus;
            document.getElementById('completeReportBtn').textContent = (currentStatus === 'Completed') ? '‚úÖ Job is Completed' : '‚úÖ Mark as Completed';
        }

        currentActiveReportId = data.uniqueId || null; 
        document.getElementById('currentReportId').textContent = `Active ID: ${currentActiveReportId && !currentActiveReportId.startsWith('NEW') ? currentActiveReportId : '-- New --'}`;
        
        initSignatureSelectors(); // Re-initialize selectors to ensure correct list
        updateRowInputs(data.rows || []); 
        window.updateActionButtons(data); 
        handleBatchNoValidation(); // Call validation on setting form data
    }

    function clearForm() {
        jobFields.forEach(f => {
            const el = document.getElementById(f);
            if (el && (el.type === 'text' || el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.type === 'email' || el.type === 'date' || el.type === 'time')) {
                 el.value = ''; 
            } else if (el && el.tagName === 'SELECT') {
                 // Ensures select fields revert to the first option, which is now N/A or a placeholder
                 el.value = el.options[0]?.value; 
            }
        });
        
        // Resetting specific default values
        document.getElementById('customerName').value = "Star Engineering";
        document.getElementById('orderQty').value = "1000";
        document.getElementById('orderQtyUnit').value = "Nos";
        document.getElementById('challan').value = "CH/2508/01 | 01.09.2025";
        document.getElementById('batchNo').value = "250819"; 
        
        // --- UPDATED: Set default sign-off to "N/A" for the VERIFIED_APPROVED_BY list
        initSignatureSelectors();
        document.getElementById('verifiedBy').value = "N/A";
        document.getElementById('approvedBy').value = "N/A";
        // --- END UPDATED ---
        
        document.getElementById('notes').value = "P- Pointage, V- Viscosity, T- Temp, S-speed, A-Adhesion.";
        document.getElementById('paint').value = 'Black'; 
        document.getElementById('silverInsp').value = 'Silver Paint';
        document.getElementById('blackInsp').value = 'Black Paint';
        document.getElementById('baseBatch').value = ''; // BLANKED as per request
        document.getElementById('topBatch').value = ''; // BLANKED as per request

        const statusEl = document.getElementById('statusField');
        if (statusEl) statusEl.value = 'Running';
        document.getElementById('completeReportBtn').textContent = '‚úÖ Mark as Completed';
        document.getElementById('completeReportBtn').disabled = true;

        currentActiveReportId = null;
        document.getElementById('currentReportId').textContent = `Active ID: -- New --`;
        document.getElementById('saveReport').textContent = 'üíæ Save New Report';
        document.getElementById('deleteReport').disabled = true;

        updateRowInputs(); 
        applyPreview();
        window.updateActionButtons(null); 
        handleBatchNoValidation(); // Call validation after clearing the form
    }
    
    // --- CLOUD LOGIC FUNCTIONS (UNCHANGED) ---

    async function handleSaveReport() {
        if (!window.auth.currentUser) {
            alert("‚ùå Please sign in to save the report.");
            return;
        }
        
        const data = getFormData();
        
        if (!data.challan || !data.customerName) {
            alert("‚ùå Challan Number and Customer Name are required.");
            return;
        }

        try {
            await window.cloudSaveReport(data, data.uniqueId);
            
            currentActiveReportId = data.uniqueId;
            document.getElementById('currentReportId').textContent = `Active ID: ${currentActiveReportId}`;
            
            setFormData(data); 
            
            alert(`‚úÖ Report successfully saved/updated to the cloud. ID: ${currentActiveReportId}`);
            
            window.loadReportsList('', 'Running'); 
            window.loadReportsList('', 'Completed'); 
            
        } catch (e) {
            console.error(e);
            alert(`‚ùå Error saving report: ${e.message}`);
        }
    }

    async function handleDeleteReport() {
        if (!currentActiveReportId || currentActiveReportId.startsWith('NEW')) {
            alert("‚ùå This is a new report, it cannot be deleted.");
            return;
        }
        
        if (!confirm(`Are you sure you want to delete report ID ${currentActiveReportId}?`)) {
            return;
        }
        
        try {
            await window.cloudDeleteReport(currentActiveReportId);
            alert(`‚úÖ Report ID ${currentActiveReportId} successfully deleted.`);
            clearForm();
            window.loadReportsList('', 'Running'); 
            window.loadReportsList('', 'Completed');
        } catch (e) {
            console.error(e);
            alert(`‚ùå Error deleting report: ${e.message}`);
        }
    }
    
    // --- loadReportsList (Initial state is collapsed) ---
    window.loadReportsList = async (query = '', statusFilter = 'Running') => {
        try {
            const reports = await window.cloudLoadReports(query, statusFilter);
            
            const containerId = (statusFilter === 'Running') ? 'runningJobsContainer' : 'completedJobsContainer';
            const container = document.getElementById(containerId);
            
            container.innerHTML = '';
            
            if (reports.length === 0) {
                 container.innerHTML = '<div style="padding:10px; text-align:center; color:#666;">No reports found.</div>';
                 return;
            }
            
            const groupedReports = {}; 
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            
            reports.forEach(report => {
                const date = new Date(report.updatedAt || report.timestamp);
                const monthYearKey = `${monthNames[date.getMonth()]} ${date.getFullYear()}`;
                const customerKey = report.customerName.trim() || 'No Customer Name';
                
                if (!groupedReports[customerKey]) {
                    groupedReports[customerKey] = {};
                }
                if (!groupedReports[customerKey][monthYearKey]) {
                    groupedReports[customerKey][monthYearKey] = [];
                }
                groupedReports[customerKey][monthYearKey].push(report);
            });
            
            for (const customerName in groupedReports) {
                const customerGroupDiv = document.createElement('div');
                customerGroupDiv.className = 'customer-group';
                
                const customerHeader = document.createElement('div');
                customerHeader.className = 'customer-header';
                
                let totalJobs = 0;
                for(const month in groupedReports[customerName]) {
                    totalJobs += groupedReports[customerName][month].length;
                }
                
                customerHeader.innerHTML = `${customerName} <span style="font-size: 11px; margin-left: 10px; font-weight: normal; color: #4b5563;">(${totalJobs} Jobs Total)</span> <span class="toggle-icon">‚ñ∂</span>`;
                customerGroupDiv.appendChild(customerHeader);

                const customerContent = document.createElement('div');
                customerContent.className = 'folder-content'; 
                customerGroupDiv.appendChild(customerContent);
                
                customerHeader.addEventListener('click', () => {
                    customerContent.classList.toggle('expanded');
                    customerHeader.querySelector('.toggle-icon').classList.toggle('expanded');
                });
                
                const sortedMonths = Object.keys(groupedReports[customerName]).sort((a, b) => {
                     const dateA = new Date(a.replace(/(\w+)\s(\d+)/, '$1 1, $2'));
                     const dateB = new Date(b.replace(/(\w+)\s(\d+)/, '$1 1, $2'));
                     return dateB - dateA; 
                });


                for (const monthYearKey of sortedMonths) {
                    const monthGroupDiv = document.createElement('div');
                    monthGroupDiv.className = 'month-group';
                    
                    const monthHeader = document.createElement('div');
                    monthHeader.className = 'month-header';
                    monthHeader.innerHTML = `${monthYearKey} (${groupedReports[customerName][monthYearKey].length} Jobs) <span class="toggle-icon">‚ñ∂</span>`;
                    customerContent.appendChild(monthHeader);
                    
                    const monthContent = document.createElement('div');
                    monthContent.className = 'folder-content'; 
                    customerContent.appendChild(monthContent);
                    
                    monthHeader.addEventListener('click', (e) => {
                        e.stopPropagation(); 
                        monthContent.classList.toggle('expanded');
                        monthHeader.querySelector('.toggle-icon').classList.toggle('expanded');
                    });
                    
                    groupedReports[customerName][monthYearKey].forEach(report => {
                        const item = document.createElement('div');
                        item.className = 'report-list-item';
                        if (report.uniqueId === currentActiveReportId) {
                             item.classList.add('selected');
                        }
                        item.dataset.id = report.uniqueId;
                        item.innerHTML = `
                            <span>${report.partDesc} <span style="font-weight: normal; color:#6b7280; margin-left: 8px;">(Batch: ${report.batchNo})</span></span>
                            <span style="font-size:10px; color:#666;">${report.challan}</span>
                        `;
                        item.addEventListener('click', () => {
                            handleLoadReport(report);
                            showView('form'); 
                        });
                        monthContent.appendChild(item);
                    });
                }
                container.appendChild(customerGroupDiv);
            }
        } catch (e) {
            console.error(`Error loading ${statusFilter} reports:`, e);
            const containerId = (statusFilter === 'Running') ? 'runningJobsContainer' : 'completedJobsContainer';
            const container = document.getElementById(containerId);
            if(container) container.innerHTML = `<div style="padding:10px; text-align:center; color:red;">Error loading reports: ${e.message}</div>`;
        }
    };


    function handleLoadReport(reportData) {
        setFormData(reportData);
        
        document.querySelectorAll('.report-list-item').forEach(item => item.classList.remove('selected'));
        
        const selectedItem = document.querySelector(`.report-list-item[data-id="${reportData.uniqueId}"]`);
        if (selectedItem) {
            selectedItem.classList.add('selected');
            
            // Logic to expand all parent folders on selection
            let currentParent = selectedItem.closest('.folder-content');
            while(currentParent) {
                currentParent.classList.add('expanded');
                const header = currentParent.previousElementSibling;
                if(header && header.querySelector('.toggle-icon')) {
                    header.querySelector('.toggle-icon').classList.add('expanded');
                }
                currentParent = currentParent.closest('.folder-content:not(.month-group .folder-content)');
                if (currentParent && currentParent.classList.contains('customer-group')) break;
                if (currentParent === selectedItem.closest('.customer-group .folder-content')) currentParent = null; 
            }
        }
    }
    
    async function handleCompleteReport() {
        if (!currentActiveReportId || currentActiveReportId.startsWith('NEW')) {
            alert("‚ùå Please load/save a report you want to mark as Completed.");
            return;
        }
        
        if (document.getElementById('statusField').value === 'Completed') {
            alert("‚ùå This job is already marked as Completed.");
            return;
        }
        
        try {
            const dataToComplete = getFormData();
            await window.cloudSaveReport(dataToComplete, dataToComplete.uniqueId);
            
            if (!confirm(`Are you sure you want to mark report ID ${currentActiveReportId} as 'Completed'? (It will move to the 'Completed Jobs' folder)`)) {
                return;
            }
            
            dataToComplete.status = 'Completed'; 
            
            await window.cloudSaveReport(dataToComplete, dataToComplete.uniqueId);
            
            document.getElementById('statusField').value = 'Completed';
            document.getElementById('completeReportBtn').textContent = '‚úÖ Job is Completed';
            
            alert(`‚úÖ Report ID ${currentActiveReportId} successfully marked as 'Completed'.`);
            
            window.loadReportsList('', 'Running'); 
            window.loadReportsList('', 'Completed'); 
            window.updateActionButtons(dataToComplete); 
            
        } catch (e) {
            console.error(e);
            alert(`‚ùå Error marking report as 'Completed' or saving it: ${e.message}`);
        }
    }


    // ------------------------------------------------------------------
    // --- applyPreview (REVISED: Updated logic for MachineNo and CycleTime display) ---
    // ------------------------------------------------------------------
    function applyPreview() {
        const data = getFormData();
        const v = (id) => document.getElementById(id)?.value || '';
        const paintType = v('paint'); 
        
        document.getElementById('pvCustomer').textContent = v('customerName');
        
        // REVISED: Display Order Qty and Unit
        document.getElementById('pvQty').textContent = `${v('orderQty')} ${v('orderQtyUnit')}`;
        
        document.getElementById('pvChallan').textContent = v('challan');
        document.getElementById('pvPart').textContent = v('partDesc');
        document.getElementById('pvBatchNo').textContent = v('batchNo');
        
        document.getElementById('pvCoating').textContent = v('coatingSpec');
        
        const pvInspHeader = document.getElementById('pvInspHeader');
        const pvInspValue = document.getElementById('pvInspValue');
        pvInspHeader.textContent = 'Paint'; 
        
        if (paintType === 'Black') {
            pvInspValue.textContent = v('blackInsp'); 
        } else if (paintType === 'Silver') {
            pvInspValue.textContent = v('silverInsp'); 
        } else {
            pvInspValue.textContent = 'N/A';
        }
        
        document.getElementById('pvBaseBatch').textContent = v('baseBatch'); 
        document.getElementById('pvTopBatch').textContent = v('topBatch'); 
        
        document.getElementById('pvVerified').textContent = v('verifiedBy');
        document.getElementById('pvApproved').textContent = v('approvedBy');
        document.getElementById('pvNotes').innerHTML = v('notes'); 

        const tbody = document.getElementById('pvRows');
        tbody.innerHTML = '';
        
        const allRows = data.rows;
        let globalSr = 1; 
        
        // --- MODIFIED LOGIC: Set requiredLength based on paintType ---
        // Silver needs 9 operations (4 pre + 3 coating + 2 post)
        // Black needs 10 operations (4 pre + 4 coating + 2 post)
        const requiredLength = (paintType === 'Silver') ? 9 : 10; 
        // -------------------------------------------------------------

        allRows.forEach(r => {
            
            const values = (r.observation || '').split(';').map(v => v.trim()); 
            const structure = PARAMETERS[r.operation]; 
            let singleObservationString = '';
            
            // üö® NEW: Cycle Time is now a separate field on 'r'
            const cycleTime = r.cycleTime || ''; 

            if(structure && structure.labels) {
                // Map the observation values to parameter keys for easy access
                let obsMap = {};
                let valIndex = 0;
                 for (let j = 0; j < structure.labels.length; j++) {
                    const label = structure.labels[j];
                    let paramKey = '';
                    
                    if (label.includes('Pre-Heating Temp')) paramKey = 'PreHeatingTemp';
                    else if (label.includes('Main Heating Temp')) paramKey = 'MainHeatingTemp';
                    else if (label.includes('Baking Temp')) paramKey = 'BakingTemp';
                    else if (label.includes('Temp') && !label.includes('Heating')) paramKey = 'Temp';
                    else if (label.includes('Viscosity')) paramKey = 'Viscosity';
                    else if (label.includes('Time/Speed')) paramKey = 'TimeSpeed';
                    else if (label.includes('Speed')) paramKey = 'Speed';
                    else if (label.includes('Pointage')) paramKey = 'Pointage';
                    else if (label.includes('Thickness')) paramKey = 'Thickness';
                    else if (label.includes('Adhesion')) paramKey = 'Adhesion';
                    else if (label.includes('Dispatch Qty')) paramKey = 'QtyValue'; 
                    else if (label.includes('Qty Unit')) paramKey = 'QtyUnit';
                    else if (label.includes('Match')) paramKey = 'Match';
                    else if (label.includes('Observation')) paramKey = 'Observation';
                    // üö® NEW: Machine No.
                    else if (label.includes('Machine No.')) paramKey = 'MachineNo';
                    // üö® NEW: Cycle Time - Skip as it's separate
                    else if (label.includes('Cycle Time')) continue; 


                    // üö® MODIFIED: Use the original `values` array for mapping
                    if (paramKey && values[valIndex] !== undefined) {
                        obsMap[paramKey] = values[valIndex] || '';
                        valIndex++;
                    }
                }
                
                // Construct the string based on parameter types
                let outputParts = [];

                if (r.operation === "Incoming Inspection") {
                    if(obsMap.Observation) outputParts.push(obsMap.Observation);
                } else if (r.operation === "Packing & Dispatch") {
                    if(obsMap.QtyValue) outputParts.push(`Q- ${obsMap.QtyValue} ${obsMap.QtyUnit || ''}`);
                    if(obsMap.Match) outputParts.push(`M- ${obsMap.Match}`);
                } else {
                    // Standard operations
                    if (obsMap.Observation) outputParts.push(`Obs: ${obsMap.Observation}`);
                    if (obsMap.Pointage) outputParts.push(`P-${obsMap.Pointage} gms/l`);
                    if (obsMap.Thickness) outputParts.push(`T-${obsMap.Thickness} microns`);
                    if (obsMap.Adhesion) outputParts.push(`A-${obsMap.Adhesion}`);
                    
                    // Coating parameters
                    if (obsMap.Viscosity) outputParts.push(`V-${obsMap.Viscosity} sec`);
                    
                    // MODIFIED: Speed logic
                    if (obsMap.Speed) {
                         const unit = obsMap.Speed.includes('box oven') ? '' : ' Hz';
                         outputParts.push(`S-${obsMap.Speed}${unit}`);
                    }
                    
                    if (obsMap.TimeSpeed) outputParts.push(`T/S-${obsMap.TimeSpeed}`);
                    
                    // Temp parameters (only display the value)
                    if (obsMap.PreHeatingTemp) outputParts.push(`PHT-${obsMap.PreHeatingTemp}`);
                    if (obsMap.MainHeatingTemp) outputParts.push(`MHT-${obsMap.MainHeatingTemp}`);
                    if (obsMap.BakingTemp) outputParts.push(`Baking-${obsMap.BakingTemp}`);
                    if (obsMap.Temp) outputParts.push(`T-${obsMap.Temp}`);
                    
                    // üö® NEW: Shot Blasting Fields
                    if (r.operation === "Shot Blasting") {
                        if(obsMap.MachineNo && obsMap.MachineNo !== 'N/A') outputParts.unshift(`Machine: ${obsMap.MachineNo}`); // Prepend Machine No.
                        if(obsMap.Time) outputParts.push(`Time: ${obsMap.Time} min`);
                        // üö® NEW: Append Cycle Time from separate field
                        if(cycleTime) outputParts.push(`Cycle Time: ${cycleTime} min`); 
                    }
                }
                
                singleObservationString = outputParts.join(' | ');

            } else {
                 singleObservationString = r.observation;
            }
           
            const specKey = r.operation.includes('Coat') ? `${paintType}_${r.operation}` : (r.operation === 'Final Inspection' ? `${r.operation}_${paintType}` : r.operation);
            const specification = SPECIFICATIONS[specKey] || r.operation;
            
            const tr = document.createElement('tr');
            const finalObservation = singleObservationString.trim();
            
            // Format Date (YYYY-MM-DD to DD/MM/YYYY)
            let displayDate = r.dateShift || '';
            if (displayDate.includes('-') && displayDate.length === 10) {
                 const [y, m, d] = displayDate.split('-');
                 displayDate = `${d}/${m}/${y}`;
            } 
            // Append shift time if available
            if (r.shiftTime) {
                 displayDate += r.dateShift ? ` / ${r.shiftTime}` : r.shiftTime; 
            }
            
            // Time values are already HH:MM format from type="time"
            const displayFromTime = r.fromTime || '';
            const displayToTime = r.toTime || '';

            const rowContent = `
                <td style="text-align:center">${globalSr}</td>
                <td>${displayDate || ''}</td>
                <td>${r.operation || ''}</td>
                <td>${specification || ''}</td> 
                <td style="font-size: 9px; line-height: 1.2;">${finalObservation}</td>
                <td style="text-align:center">${displayFromTime}</td>
                <td style="text-align:center">${displayToTime}</td>
                <td style="text-align:center; font-weight: bold;">${r.inspectionStatus || ''}</td> 
                <td>${r.supervisorSign || ''}</td> `; 

            tr.innerHTML = rowContent;
            tbody.appendChild(tr);
            
            const rowHeight = (globalSr === 1) ? '5mm' : '18mm';
            tr.style.height = rowHeight; 
            tr.querySelectorAll('td').forEach(td => td.style.height = rowHeight);
            
            globalSr++;
        });
        
        let currentOutputRows = tbody.querySelectorAll('tr').length;
        
        // Fill remaining rows with empty rows up to requiredLength (9 for Silver, 10 for Black)
        if (currentOutputRows < requiredLength) {
            for (let i = 0; i < requiredLength - currentOutputRows; i++) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td style="text-align:center">${globalSr + i}</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>`; 
                tbody.appendChild(tr);
                
                const blankSr = globalSr + i;
                const rowHeight = (blankSr === 1) ? '5mm' : '18mm';
                tr.style.height = rowHeight; 
                tr.querySelectorAll('td').forEach(td => td.style.height = rowHeight);
            }
        }
    }
    
    // ------------------------------------------------------------------
    // --- generatePdfWithAutoTable (REVISED: Updated logic for MachineNo and CycleTime display) ---
    // ------------------------------------------------------------------
    async function generatePdfWithAutoTable() {
        try {
            const data = getFormData();
            const v = (id) => document.getElementById(id)?.value || '';
            const paintType = v('paint'); 
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pageHeight = pdf.internal.pageSize.getHeight(); 
            const bottomMargin = 10;
            const availablePageEnd = pageHeight - bottomMargin; 
            let yOffset = 15; 

            // --- Header and Format No. ---
            pdf.setFontSize(14);
            pdf.text("JOB CARD / ROUTE CARD", 105, yOffset, null, null, "center");
            yOffset += 7;

            pdf.setFontSize(6.5); 
            pdf.text(`Format No: WT/PDR/11  |  REV. NO: 01  |  REV. DATE: 01.09.2025`, 105, yOffset, null, null, "center");
            yOffset += 5;
            
            // --- General Info Table ---
            const generalInfo = [
                ["Customer Name", v('customerName'), "Order/Challan Qty", `${v('orderQty')} ${v('orderQtyUnit')}`],
                ["Customer Challan No/Date", v('challan'), "Batch No.", v('batchNo')],
                ["Part Desc/No", v('partDesc'), "Coating Spec", v('coatingSpec')]
            ];

            pdf.autoTable({
                startY: yOffset,
                head: [],
                body: generalInfo,
                theme: 'grid',
                styles: { fontSize: 6.5, cellPadding: 0.8, lineColor: 0, lineWidth: 0.2 },
                columnStyles: { 0: { cellWidth: 30, fontStyle: 'bold' }, 2: { cellWidth: 30, fontStyle: 'bold' } },
                didDrawPage: (data) => { yOffset = data.cursor.y + 3; }
            });

            // --- Coating Batch Table ---
            const coatingInfo = [
                [v('coatingSpec'), paintType === 'Black' ? v('blackInsp') : v('silverInsp'), v('baseBatch'), v('topBatch')]
            ];
            
            pdf.autoTable({
                startY: yOffset,
                head: [['COATING SPECIFICATION', 'Paint', 'BASE COAT BATCH NO.', 'TOP COAT BATCH NO.']],
                body: coatingInfo,
                theme: 'grid',
                styles: { fontSize: 6.5, cellPadding: 0.8, lineColor: 0, lineWidth: 0.2, halign: 'center' },
                headStyles: { fillColor: [200, 200, 200], fontStyle: 'bold', fontSize: 6.5 },
                didDrawPage: (data) => { yOffset = data.cursor.y + 3; }
            });
            
            // --- Main Operations Table ---
            
            const mainHeader = [
                'Sr No', 'Date/Shift', 'Operation', 'Specifications', 'Observation', 
                'From Time', 'To Time', 'Inspection OK/NOK', 'Operator/Supervisor/QA Signature'
            ];
            
            const mainBody = [];
            const allRows = data.rows;
            let globalSr = 1;
            
            // --- MODIFIED LOGIC: Set requiredLength based on paintType for PDF ---
            const requiredLength = (paintType === 'Silver') ? 9 : 10; 
            // ----------------------------------------------------------------------

            allRows.forEach(r => {
                
                const values = (r.observation || '').split(';').map(v => v.trim()); 
                const structure = PARAMETERS[r.operation]; 
                let finalObservation = ''; 
                
                // üö® NEW: Cycle Time is now a separate field on 'r'
                const cycleTime = r.cycleTime || ''; 

                if(structure && structure.labels) {
                    // Map the observation values to parameter keys for easy access
                    let obsMap = {};
                    let valIndex = 0;
                     for (let j = 0; j < structure.labels.length; j++) {
                        const label = structure.labels[j];
                        let paramKey = '';
                        
                        if (label.includes('Pre-Heating Temp')) paramKey = 'PreHeatingTemp';
                        else if (label.includes('Main Heating Temp')) paramKey = 'MainHeatingTemp';
                        else if (label.includes('Baking Temp')) paramKey = 'BakingTemp';
                        else if (label.includes('Temp') && !label.includes('Heating')) paramKey = 'Temp';
                        else if (label.includes('Viscosity')) paramKey = 'Viscosity';
                        else if (label.includes('Time/Speed')) paramKey = 'TimeSpeed';
                        else if (label.includes('Speed')) paramKey = 'Speed';
                        else if (label.includes('Pointage')) paramKey = 'Pointage';
                        else if (label.includes('Thickness')) paramKey = 'Thickness';
                        else if (label.includes('Adhesion')) paramKey = 'Adhesion';
                        else if (label.includes('Dispatch Qty')) paramKey = 'QtyValue'; 
                        else if (label.includes('Qty Unit')) paramKey = 'QtyUnit';
                        else if (label.includes('Match')) paramKey = 'Match';
                        else if (label.includes('Observation')) paramKey = 'Observation';
                        // üö® NEW: Machine No.
                        else if (label.includes('Machine No.')) paramKey = 'MachineNo';
                        // üö® NEW: Cycle Time - Skip as it's separate
                        else if (label.includes('Cycle Time')) continue; 


                        // üö® MODIFIED: Use the original `values` array for mapping
                        if (paramKey && values[valIndex] !== undefined) {
                            obsMap[paramKey] = values[valIndex] || '';
                            valIndex++;
                        }
                    }
                    
                    // Construct the string based on parameter types (PDF version)
                    let outputParts = [];

                    if (r.operation === "Incoming Inspection") {
                        if(obsMap.Observation) outputParts.push(obsMap.Observation);
                    } else if (r.operation === "Packing & Dispatch") {
                        if(obsMap.QtyValue) outputParts.push(`Q- ${obsMap.QtyValue} ${obsMap.QtyUnit || ''}`);
                        if(obsMap.Match) outputParts.push(`M- ${obsMap.Match}`);
                    } else {
                        // Standard operations
                        if (obsMap.Observation) outputParts.push(`Obs: ${obsMap.Observation}`);
                        if (obsMap.Pointage) outputParts.push(`P-${obsMap.Pointage} gms/l`);
                        if (obsMap.Thickness) outputParts.push(`T-${obsMap.Thickness} microns`);
                        if (obsMap.Adhesion) outputParts.push(`A-${obsMap.Adhesion}`);
                        
                        // Coating parameters
                        if (obsMap.Viscosity) outputParts.push(`V-${obsMap.Viscosity} sec`);
                        
                        // MODIFIED: Speed logic
                        if (obsMap.Speed) {
                             const unit = obsMap.Speed.includes('box oven') ? '' : ' Hz';
                             outputParts.push(`S-${obsMap.Speed}${unit}`);
                        }
                        
                        if (obsMap.TimeSpeed) outputParts.push(`T/S-${obsMap.TimeSpeed}`);
                        
                        // Temp parameters (only display the value)
                        if (obsMap.PreHeatingTemp) outputParts.push(`PHT-${obsMap.PreHeatingTemp}`);
                        if (obsMap.MainHeatingTemp) outputParts.push(`MHT-${obsMap.MainHeatingTemp}`);
                        if (obsMap.BakingTemp) outputParts.push(`Baking-${obsMap.BakingTemp}`);
                        if (obsMap.Temp) outputParts.push(`T-${obsMap.Temp}`);
                        
                        // üö® NEW: Shot Blasting Fields
                        if (r.operation === "Shot Blasting") {
                            if(obsMap.MachineNo && obsMap.MachineNo !== 'N/A') outputParts.unshift(`Machine: ${obsMap.MachineNo}`); // Prepend Machine No.
                            if(obsMap.Time) outputParts.push(`Time: ${obsMap.Time} min`);
                            // üö® NEW: Append Cycle Time from separate field
                            if(cycleTime) outputParts.push(`Cycle Time: ${cycleTime} min`); 
                        }
                    }
                    
                    finalObservation = outputParts.join(' | ');

                } else {
                     finalObservation = r.observation;
                }
                
                const specKey = r.operation.includes('Coat') ? `${paintType}_${r.operation}` : (r.operation === 'Final Inspection' ? `${r.operation}_${paintType}` : r.operation);
                const specification = SPECIFICATIONS[specKey] || r.operation;
                
                // Format Date (YYYY-MM-DD to DD/MM/YYYY) for PDF
                let displayDate = r.dateShift || '';
                if (displayDate.includes('-') && displayDate.length === 10) {
                     const [y, m, d] = displayDate.split('-');
                     displayDate = `${d}/${m}/${y}`;
                } 
                // Append shift time if available
                if (r.shiftTime) {
                    displayDate += displayDate ? ` / ${r.shiftTime}` : r.shiftTime;
                }
                
                // Time values are already HH:MM format from type="time"
                const displayFromTime = r.fromTime || '';
                const displayToTime = r.toTime || '';
                
                
                mainBody.push([
                    globalSr,
                    displayDate.trim() || '',
                    r.operation || '',
                    specification || '', 
                    finalObservation.trim(),
                    displayFromTime,
                    displayToTime,
                    r.inspectionStatus || '', 
                    r.supervisorSign || '' 
                ]);
                globalSr++;
            });
            
            while (mainBody.length < requiredLength) {
                mainBody.push([globalSr++, '', '', '', '', '', '', '', '']); 
            }
            
            pdf.autoTable({
                startY: yOffset,
                head: [mainHeader],
                body: mainBody,
                theme: 'grid',
                styles: { 
                    fontSize: 6.5, 
                    cellPadding: 0.8, 
                    lineColor: 0, 
                    lineWidth: 0.2, 
                    valign: 'middle', 
                    minCellHeight: 18.0 
                },
                headStyles: { 
                    fillColor: [200, 200, 200], 
                    fontStyle: 'bold', 
                    valign: 'middle', 
                    lineWidth: 0.2, 
                    lineColor: 0,
                    fontSize: 6.5 
                },
                columnStyles: {
                    0: { cellWidth: 8, halign: 'center' }, 
                    1: { cellWidth: 15 }, 
                    2: { cellWidth: 18 }, 
                    3: { cellWidth: 45 }, 
                    4: { cellWidth: 32 }, 
                    5: { cellWidth: 12, halign: 'center' }, 
                    6: { cellWidth: 12, halign: 'center' }, 
                    7: { cellWidth: 15, halign: 'center' }, 
                    8: { cellWidth: 33 } 
                },
                didParseCell: (data) => {
                    if (data.section === 'body' && data.row.index === 0) {
                         data.cell.styles.minCellHeight = 5.0; 
                    } else if (data.section === 'body') {
                         data.cell.styles.minCellHeight = 18.0; 
                    }
                    
                    if (data.section === 'body' && data.column.dataKey === 4 && data.cell.text.length > 1) {
                        data.cell.styles.fontSize = 5.5; 
                    }
                },
                didDrawPage: (data) => { yOffset = data.cursor.y + 3; }
            });
            
            // --- Footer ---
            let footerY = Math.max(pdf.autoTable.previous.finalY + 3, availablePageEnd - 10);
            
            pdf.setFontSize(6.5); 
            pdf.text(`Verified By: ${v('verifiedBy')}`, 10, footerY);
            pdf.text(`Approved By: ${v('approvedBy')}`, 200, footerY, null, null, 'right');
            footerY += 4;
            pdf.text(`Note - ${v('notes')}`, 10, footerY);
            
            // Custom Filename Logic
            const custNameClean = v('customerName').replace(/[^a-zA-Z0-9]/g, '_').substring(0, 15);
            const partNoClean = v('partDesc').replace(/[^a-zA-Z0-9]/g, '_').substring(0, 10);
            const challanClean = v('challan').replace(/[^a-zA-Z0-9]/g, '_').substring(0, 15);
            
            const fileName = `JobCard_${custNameClean}_${partNoClean}_${challanClean}.pdf`;
            pdf.save(fileName);
            
        } catch (error) {
            console.error("PDF Generation Error:", error);
            alert(`‚ùå PDF Generation Error: ${error.message}. Please check the browser console.`);
        }
    }
    
    // --- Event Listeners (FINAL) ---
    document.getElementById('downloadPdfBtn').addEventListener('click', generatePdfWithAutoTable); 
    document.getElementById('printBtn').addEventListener('click', () => {
        applyPreview(); 
        window.print();
    });
    
    document.getElementById('applyBtn').addEventListener('click', applyPreview);
    document.getElementById('clearBtn').addEventListener('click', clearForm);
    
    // Call updateRowInputs and applyPreview on paint change
    document.getElementById('paint').addEventListener('change', () => {
        updateRowInputs(getFormData().rows); // Update the rows with new specs and inputs
    });
    
    document.getElementById('updateOpsBtn').addEventListener('click', () => {
        updateRowInputs(getFormData().rows); 
    });


    document.getElementById('saveReport').addEventListener('click', handleSaveReport);
    document.getElementById('deleteReport').addEventListener('click', handleDeleteReport);
    
    document.getElementById('homeViewBtn').addEventListener('click', () => showView('home'));
    document.getElementById('formViewBtn').addEventListener('click', () => showView('form'));
    document.getElementById('newJobFromHome').addEventListener('click', () => {
        clearForm();
        showView('form');
    });
    document.getElementById('completeReportBtn').addEventListener('click', handleCompleteReport); 
    
    document.getElementById('newReportBtn').addEventListener('click', () => {
        clearForm();
        showView('form');
    });
    
    // Add listeners for new Qty fields
    document.getElementById('orderQty').addEventListener('input', applyPreview);
    document.getElementById('orderQtyUnit').addEventListener('change', applyPreview);
    
    // NEW: Batch No validation listener
    document.getElementById('batchNo').addEventListener('input', handleBatchNoValidation);
    
    // NEW: Listeners for Base/Top Batch No. to control operation fields
    document.getElementById('baseBatch').addEventListener('input', handleOperationFieldDisabling);
    document.getElementById('topBatch').addEventListener('input', handleOperationFieldDisabling);
    
    // Set up initial state on load
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize the two signature selectors once DOM is ready
        initSignatureSelectors(); 
        clearForm(); 
    });
  </script>
</div>
</body>
</html>.
