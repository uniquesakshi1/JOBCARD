<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Job Card / Route Card - Cloud App (PWA)</title>
  
  <link rel="manifest" href="manifest.json">
  
  <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, getDocs, deleteDoc } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js';
        
        // --- FIREBASE CONFIGURATION (YOUR UPDATED KEYS) ---
        // These keys should match the project where you enabled Authentication and Firestore.
        const firebaseConfig = {
            apiKey: "AIzaSyAaQoa6pSF7ZEPne6BYT8V7l6OslHPTYjw",
            authDomain: "jobcard-app-7b99c.firebaseapp.com",
            projectId: "jobcard-app-7b99c",
            storageBucket: "jobcard-app-7b99c.firebasestorage.app",
            messagingSenderId: "36117182109",
            appId: "1:36117182109:web:3007d2193063100d3c4674"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.auth = getAuth(app); 
        
        // --- AUTHENTICATION FUNCTIONS ---
        window.handleAuthAction = async (actionType) => {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            if (actionType !== 'logout' && (!email || !password)) {
                alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§à‡§Æ‡•á‡§≤ ‡§î‡§∞ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§°‡§æ‡§≤‡•á‡§Ç‡•§");
                return;
            }

            try {
                if (actionType === 'signup') {
                    await createUserWithEmailAndPassword(window.auth, email, password);
                    alert(`‚úÖ Signed Up and Logged In as ${email}.`);
                } else if (actionType === 'signin') {
                    await signInWithEmailAndPassword(window.auth, email, password);
                    alert(`‚úÖ Signed In as ${email}.`);
                } else if (actionType === 'logout') {
                    await signOut(window.auth);
                    alert("üëã Logged Out successfully!");
                }
            } catch (error) {
                alert(`‚ùå Auth Failed: ${error.message}`);
            }
        };

        // Auth Listener to update UI status (defined in the main script block below)
        onAuthStateChanged(window.auth, (user) => {
            if (window.updateAuthUI) {
                window.updateAuthUI(user);
            }
        });
        
        // Expose Firebase functions to the main script
        window.cloudSaveReport = async (data, docId) => {
            const record = {
                ...data, // Spread all form data
                timestamp: new Date().toISOString(),
                savedBy: window.auth.currentUser.email
            };
             await setDoc(doc(window.db, 'job_cards', docId), record); 
        };
        
        window.cloudLoadReports = async (query = '') => {
            const reports = [];
            const q = collection(window.db, 'job_cards');
            const querySnapshot = await getDocs(q);
            
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                const searchString = `${data.challan} ${data.batchNo} ${data.customerName} ${data.partDesc} ${data.uniqueId}`.toLowerCase();
                if (!query || searchString.includes(query.toLowerCase())) {
                    reports.push(data);
                }
            });
            return reports;
        };

        window.cloudDeleteReport = async (docId) => {
            await deleteDoc(doc(window.db, 'job_cards', docId));
        };
        
    </script>
    
  <style>
    /* ------------------- STYLES (Your Original Styles) ------------------- */
    body { font-family: Arial, sans-serif; margin: 12px; background:#f5f5f5; font-size: 14px; }
    .container { display: flex; gap: 12px; min-height: 85vh; }
    .panel { background: white; padding: 12px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,.08); }
    .form { width: 36%; max-width:420px; overflow-y:auto; height:85vh; flex-shrink: 0; }
    .preview-wrap { width: 64%; display:flex; flex-direction:column; gap:8px; align-items:center; flex-grow: 1; min-width: 300px; }
    .preview { width:100%; max-width:210mm; height: auto; min-height: 297mm; background:white; box-shadow:0 2px 8px rgba(0,0,0,.12); padding:12mm; box-sizing:border-box; overflow-x: auto; font-size: 12px; }
    h2 { text-align:center; margin:0 0 8px 0; font-size:18px; }
    label { display:block; font-size:13px; margin-top:8px; }
    input[type="text"], input[type="date"], select { width:100%; padding:6px 8px; margin-top:4px; box-sizing:border-box; border: 1px solid #ccc; border-radius: 4px; }
    .top-grid { display:flex; gap:8px; }
    .top-grid > div { flex:1; }
    .actions { display:flex; gap:8px; margin-top:8px; }
    button { padding:8px 10px; border: none; background:#2563eb; color:white; border-radius:6px; cursor:pointer; font-size: 14px;}
    button.secondary { background:#6b7280; }
    button.delete-btn { background:#dc2626; } 
    button.pdf-btn { background:#f97316; }
    button.print-btn { background:#059669; }
    button:disabled { background:#9ca3af; cursor: not-allowed; }
    .note { font-size:12px; color:#666; margin-top:8px; }
    table { width:100%; border-collapse: collapse; table-layout: auto; }
    table th, table td { border:1px solid #444; padding:6px; text-align:left; vertical-align:top; line-height: 1.3; }
    .rows-input { max-height:300px; overflow-y:auto; margin-top:8px; border:1px solid #ddd; padding:6px; border-radius:6px; background: #fcfcfc; }
    .row-group { border: 1px solid #eee; padding: 8px; margin-bottom: 10px; border-radius: 4px; background: #fff; }
    .row-header { font-weight: bold; margin-bottom: 6px; font-size: 13px; display: flex; justify-content: space-between; align-items: center; background: #f9f9f9; padding: 4px; border-radius: 4px; }
    .row-detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-top: 6px; }
    .observation-fields { border-top: 1px dashed #ddd; padding-top: 8px; margin-top: 8px; }
    .report-search-section { border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 10px; }
    .search-area { display: flex; gap: 8px; margin-bottom: 8px; }
    .report-list-container { max-height: 150px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 8px; }
    .report-item { padding: 6px 8px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.2s; font-size: 13px; }
    .report-item.selected { background: #dbeafe; font-weight: bold; border-left: 5px solid #2563eb; padding-left: 3px; }
    .report-item:hover { background: #f0f0f0; }
    .report-actions-bottom { display: flex; gap: 8px; margin-top: 10px; justify-content: space-between; }
    .full-width-grid { grid-template-columns: 1fr; } 
    .operator-supervisor-grid { 
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        gap: 6px; 
        border-top: 1px dashed #ddd; 
        padding-top: 8px; 
        margin-top: 8px; 
    }
    /* New: Login Bar Styles (Minimal intrusion) */
    .auth-bar {
        background-color: #f0f8ff;
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 6px;
        margin-bottom: 12px;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
    }
    .auth-bar input { padding: 4px 6px; border: 1px solid #999; border-radius: 3px; margin-right: 5px; width: 140px; }
    .auth-bar button { padding: 4px 8px; margin-left: 5px; cursor: pointer; border: none; border-radius: 3px; font-weight: bold; font-size: 13px; }
    .auth-status-text { font-weight: bold; margin-right: 10px; font-size: 14px; }
    .auth-controls { display: flex; align-items: center; flex-wrap: wrap; }
    
    @media (max-width: 900px) {
        .container { flex-direction: column; }
        .form { width: 100%; max-width: none; height: auto; order: 1; }
        .preview-wrap { width: 100%; order: 2; align-items: stretch; }
        .preview { min-height: 200px; padding: 5px; box-shadow: none; overflow-x: auto; }
        .preview table { min-width: 750px; }
        .auth-bar { flex-direction: column; align-items: stretch; }
        .auth-controls { justify-content: center; margin-top: 8px; }
        .auth-bar input { width: calc(50% - 10px); margin: 5px; }
        .auth-bar button { width: auto; margin: 5px; }
    }
    @media print {
        body * { visibility: hidden; }
        .preview, .preview * { visibility: visible; }
        .preview { position: absolute; left:0; top:0; box-shadow:none; width: 210mm; height: 297mm; padding: 12mm; margin: 0; overflow: hidden; }
        .preview table { min-width: auto; }
    }
  </style>
</head>
<body>
    
  <div class="auth-bar">
    <div id="loggedOutUI" class="auth-controls">
        <span class="auth-status-text" id="authStatus" style="color: #dc2626;">Status: Logged Out (Cloud Disabled)</span>
        <input type="email" id="loginEmail" placeholder="Email" value="test@jobcard.com">
        <input type="password" id="loginPassword" placeholder="Password" value="password123">
        <button id="loginButton" style="background-color: #3f51b5; color: white;">Sign In</button>
        <button id="signUpButton" style="background-color: #059669; color: white;">Sign Up</button>
    </div>
    
    <div id="loggedInUI" class="auth-controls" style="display: none;">
        <span class="auth-status-text" id="userEmailDisplay" style="color: #059669;"></span>
        <button id="logoutButton" style="background-color: #f97316; color: white;">Log Out</button>
    </div>
  </div>
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px; flex-wrap: wrap;">
    <h1 style="font-size:18px;margin:0 0 5px 0;">Job Card / Route Card ‚Äî Cloud PWA System</h1>
    <div class="actions" style="width: auto; align-items: center; flex-wrap: wrap;">
      <span id="currentReportId" style="font-size:14px; color:#666; margin-right: 15px;">Active ID: -- New --</span>
      <button id="downloadPdfBtn" class="pdf-btn">‚¨áÔ∏è Download PDF</button>
      <button id="printBtn" class="print-btn">üñ®Ô∏è Print Job Card</button>
    </div>
  </div>

  <div class="container">
    <div class="panel form">
      
      <div class="report-search-section">
        <h2 style="font-size: 16px; text-align: left; margin-bottom: 8px; color:#2563eb;">Reports Folder (Cloud Save)</h2>
        
        <div class="search-area">
          <input id="reportSearch" type="text" placeholder="Challan / Part / Customer ‡§∏‡•á ‡§ñ‡•ã‡§ú‡•á‡§Ç" />
          <button id="searchBtn" disabled>üîç</button>
        </div>
        
        <div id="reportListContainer" class="report-list-container">
          <div style="padding:10px; text-align:center;">Login is required to load reports from Cloud.</div>
        </div>
        
        <div class="report-actions-bottom">
          <button id="newReportBtn" class="secondary" style="background:#10b981;">‚ûï New Job Card</button>
          <button id="saveReport" disabled>üíæ Save New Report</button>
          <button id="deleteReport" class="delete-btn" disabled>üóëÔ∏è Delete</button>
        </div>
        <div class="note" style="color: #f97316; font-weight: bold;">üîë Report Customer/Part/Challan No ‡§∏‡•á Save ‡§π‡•ã‡§ó‡•Ä‡•§</div>
        <div class="note" style="color: #dc2626; font-weight: bold;">‚ö†Ô∏è ‡§Ø‡§π ‡§°‡•á‡§ü‡§æ ‡§ï‡•ç‡§≤‡§æ‡§â‡§° (Firebase) ‡§™‡§∞ ‡§∏‡•á‡§µ ‡§π‡•ã‡§ó‡§æ‡•§</div>
      </div>
      
      <h2 style="margin-top:20px;">General Information</h2>
      <label>Customer Name
        <input id="customerName" type="text" placeholder="Customer name" value="Star Engineering" />
      </label>
      <div class="top-grid">
        <div><label>Order/Challan Qty<input id="orderQty" type="text" placeholder="Qty" value="1000 Pcs" /></label></div>
        <div><label>Challan No/Date<input id="challan" type="text" placeholder="No / Date" value="CH/2508/01 | 01.09.2025" /></label></div>
      </div>
      <label>Part Desc / No<input id="partDesc" type="text" placeholder="Part description or no" value="LAC09170" /></label>
      <div class="top-grid">
        <div><label>Coating Spec (e.g. 2B, 1T)</label><input id="coatingSpec" type="text" placeholder="e.g. 1B,2B,1T" value="2 Base | 2 Top"/></div>
        <div>
          <label>Paint
            <select id="paint">
                <option value="Silver">Silver</option>
                <option value="Black" selected>Black</option>
            </select>
            <button id="updateOpsBtn" style="width:100%; margin-top:5px; padding: 8px;">Update Operations</button>
          </label>
        </div>
      </div>
      <label>Batch No<input id="batchNo" type="text" placeholder="Batch number" value="250819" /></label>
      <h2 style="margin-top:20px;">Operation Details (Input Fields)</h2>
      <div class="rows-input"><div id="rowsInput"></div></div>
      <div class="note">‡§π‡§∞ ‡§ë‡§™‡§∞‡•á‡§∂‡§® ‡§ï‡•á ‡§®‡•Ä‡§ö‡•á **Observation** ‡§´‡•Ä‡§≤‡•ç‡§°‡•ç‡§∏ ‡§Æ‡•á‡§Ç ‡§Ö‡§≤‡§ó-‡§Ö‡§≤‡§ó ‡§µ‡•à‡§≤‡•ç‡§Ø‡•Ç ‡§≠‡§∞‡•á‡§Ç‡•§</div>
      <h2 style="margin-top:20px;">Signatures & Notes</h2>
      <label>Verified By<input id="verifiedBy" type="text" placeholder="Verified by" value="SAKSHI CHAVHAN" /></label>
      <label>Approved By<input id="approvedBy" type="text" placeholder="Approved by" value="ABHIJEET DHOKRAT" /></label>
      <label>Notes<input id="notes" type="text" placeholder="Notes / Remark" value="Job Card initiated with Batch 250819. Coating system used: Black." /></label>
      <div class="actions">
        <button id="applyBtn">Apply to Preview</button>
        <button id="clearBtn" class="secondary">Clear Form</button>
      </div>
    </div>

    <div class="preview-wrap">
      <div class="panel" style="width:100%; padding:8px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div class="small">ISO 9001:2015</div>
          <div class="small">Format No: WT/PDR/11</div>
        </div>
      </div>
      <div id="preview" class="preview panel">
        <h2>JOB CARD / ROUTE CARD</h2>
        <table style="margin-bottom:8px; table-layout: auto;">
          <tr><td style="width:18%">Customer Name</td><td id="pvCustomer" style="width:32%"></td><td style="width:18%">Order/Challan Qty</td><td id="pvQty" style="width:32%"></td></tr>
          <tr><td>Customer Challan No/Date</td><td id="pvChallan"></td><td>Part Desc/No</td><td><span id="pvPart"></span></td></tr>
          <tr><td>Coating Spec</td><td id="pvCoating"></td><td>Paint</td><td id="pvPaint"></td></tr>
          <tr><td>Batch No</td><td id="pvBatch"></td><td></td><td></td></tr>
        </table>
        <table id="pvTable">
          <thead>
            <tr><th style="width:4%">Sr</th><th style="width:10%">Date/Shift</th><th style="width:15%">Operation</th><th style="width:17%">Observation</th><th style="width:8%">From Time</th><th style="width:8%">To Time</th><th style="width:7%">Qty</th><th style="width:10%">Inspection OK/NOK</th><th style="width:10%">Operator/Checked</th><th style="width:11%">Supervisor Sign</th></tr>
          </thead>
          <tbody id="pvRows"></tbody>
        </table>
        <div style="display:flex;justify-content:space-between;margin-top:6px;">
          <div>Verified By: <span id="pvVerified"></span></div>
          <div>Approved By: <span id="pvApproved"></span></div>
        </div>
        <div style="margin-top:6px;">Notes: <span id="pvNotes"></span></div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <script>
    let currentActiveReportId = null; 
    const jobFields = ['customerName','orderQty','challan','partDesc','coatingSpec','paint','batchNo','verifiedBy','approvedBy','notes'];
    
    // --- JOB CARD CONSTANTS (Operations) ---
    const RANGES = {
        POINTAGE: "Paintage (45-65 gms/lit)",
        DRYING: "Temp (140-160 ¬∞C), Time (10-15 min)",
        SHOT_BLASTING: "Cycle time (15-20 min)",
        FINAL_CHECK: "Thickness (range), Visual Check",
        PACKING_CHECK: "Qty (value), Match Check",
    };

    const PARAMETERS = {
        "Incoming Inspection": { labels: ["Challan QTY/Part Match"], units: [""] },
        "Alkaline Cleaning": { labels: ["Paintage"], units: ["gms/lit"] }, 
        "Drying": { labels: ["Temp", "Time"], units: ["¬∞C", "min"] }, 
        "Shot Blasting": { labels: ["Cycle time"], units: ["min"] },
        "Base Coat -1 & Curing": { labels: ["Viscosity", "Temp", "Curing"], units: ["sec", "¬∞C", ""], isCoating: true },
        "Base Coat -2 & Curing": { labels: ["Viscosity", "Temp", "Curing"], units: ["sec", "¬∞C", ""], isCoating: true },
        "Top Coat -1 & Curing": { labels: ["Viscosity", "Temp", "Curing"], units: ["sec", "¬∞C", ""], isCoating: true },
        "Top Coat -2 & Curing": { labels: ["Viscosity", "Temp", "Curing"], units: ["sec", "¬∞C", ""], isCoating: true },
        "Final Inspection": { labels: ["Thickness", "Visual Check"], units: [""] },
        "Packing & Dispatch": { labels: ["Qty", "Match"], units: [""] },
        "Spare Operation": { labels: ["N/A"], units: [""] },
    };
    
    // Base permanent operations
    const BASE_OPERATIONS = [
      { op: "Incoming Inspection", guide: RANGES.FINAL_CHECK, color: 'N/A' },
      { op: "Alkaline Cleaning", guide: RANGES.POINTAGE, color: 'N/A' },
      { op: "Drying", guide: RANGES.DRYING, color: 'N/A' },
      { op: "Shot Blasting", guide: RANGES.SHOT_BLASTING, color: 'N/A' },
      // Coating steps will be inserted here based on paint type
      { op: "Final Inspection", guide: RANGES.FINAL_CHECK, color: 'N/A' },
      { op: "Packing & Dispatch", guide: RANGES.PACKING_CHECK, color: 'N/A' }
    ];
    
    // --- AUTH UI HANDLER (Connects to Firebase in module block) ---
    window.updateAuthUI = (user) => {
        const loggedInUI = document.getElementById('loggedInUI');
        const loggedOutUI = document.getElementById('loggedOutUI');
        const authStatus = document.getElementById('authStatus');
        const userEmailDisplay = document.getElementById('userEmailDisplay');
        const saveButton = document.getElementById('saveReport');
        const searchButton = document.getElementById('searchBtn');
        const deleteButton = document.getElementById('deleteReport');
        
        if (user) {
            // Logged In: Enable Cloud features
            loggedOutUI.style.display = 'none';
            loggedInUI.style.display = 'flex';
            userEmailDisplay.textContent = `Logged in as: ${user.email}`;
            authStatus.textContent = "Status: Logged In (Cloud Active)";
            authStatus.style.color = '#059669';
            saveButton.disabled = false;
            searchButton.disabled = false;
            fetchAndDisplayReports(''); // Load reports when logged in
        } else {
            // Logged Out: Disable Cloud features
            loggedOutUI.style.display = 'flex';
            loggedInUI.style.display = 'none';
            authStatus.textContent = "Status: Logged Out (Cloud Disabled)";
            authStatus.style.color = '#dc2626';
            saveButton.disabled = true;
            searchButton.disabled = true;
            deleteButton.disabled = true;
            document.getElementById('reportListContainer').innerHTML = `<div style="padding:10px; text-align:center;">Login is required to load reports from Cloud.</div>`;
            updateActionButtons(null);
        }
    };

    // --- Core Logic Functions ---
    function getCurrentPredefinedOperations() {
        const paintSelect = document.getElementById('paint');
        const paintType = paintSelect.value;
        const ops = JSON.parse(JSON.stringify(BASE_OPERATIONS)); 
        const coatingSteps = [];

        // --- FIXED: Color Logic (Only Black and Silver) ---
        if (paintType === 'Black') {
            // Black: 2 Base, 2 Top (4 coats, 10 operations total)
            document.getElementById('coatingSpec').value = "2 Base | 2 Top";
            coatingSteps.push(
                { op: "Base Coat -1 & Curing", guide: "Viscosity/Temp/Curing", color: 'Black' },
                { op: "Base Coat -2 & Curing", guide: "Viscosity/Temp/Curing", color: 'Black' },
                { op: "Top Coat -1 & Curing", guide: "Viscosity/Temp/Curing", color: 'Black' },
                { op: "Top Coat -2 & Curing", guide: "Viscosity/Temp/Curing", color: 'Black' }
            );
        } else if (paintType === 'Silver') {
             // Silver: 2 Base, 1 Top (3 coats, 9 operations total)
             document.getElementById('coatingSpec').value = "2 Base | 1 Top";
             coatingSteps.push(
                { op: "Base Coat -1 & Curing", guide: "Viscosity/Temp/Curing", color: 'Silver' },
                { op: "Base Coat -2 & Curing", guide: "Viscosity/Temp/Curing", color: 'Silver' },
                { op: "Top Coat -1 & Curing", guide: "Viscosity/Temp/Curing", color: 'Silver' }
            );
        } else {
             // Default/Other: Black settings as default if somehow another value sneaks in
             document.getElementById('coatingSpec').value = "2 Base | 2 Top";
             coatingSteps.push(
                { op: "Base Coat -1 & Curing", guide: "Viscosity/Temp/Curing", color: 'Black' },
                { op: "Base Coat -2 & Curing", guide: "Viscosity/Temp/Curing", color: 'Black' },
                { op: "Top Coat -1 & Curing", guide: "Viscosity/Temp/Curing", color: 'Black' },
                { op: "Top Coat -2 & Curing", guide: "Viscosity/Temp/Curing", color: 'Black' }
            );
        }

        const finalInspectionIndex = ops.findIndex(op => op.op === 'Final Inspection');
        ops.splice(finalInspectionIndex, 0, ...coatingSteps);
        
        // Final length check (Spare Operations logic)
        let requiredLength = (paintType === 'Silver') ? 9 : 10;
        
        const initialCount = ops.length;
        if (initialCount > requiredLength) {
            while(ops.length > requiredLength && ops[ops.length - 1].op === "Spare Operation") {
                ops.pop();
            }
        }
        
        while (ops.length < requiredLength) { 
            ops.push({ op: "Spare Operation", guide: "N/A", color: 'N/A' }); 
        }
        
        return ops; 
    }

    function updateRowInputs(savedRows = []) {
        const predefinedOperations = getCurrentPredefinedOperations();
        const rowsInputContainer = document.getElementById('rowsInput');
        rowsInputContainer.innerHTML = ''; 
        
        const mapSavedData = (rows) => {
            const dataMap = {};
            rows.forEach(r => {
                const opParams = PARAMETERS[r.operation] || { labels: [], units: [] };
                const values = (r.observation || '').split(',').map(v => v.trim()); 
                const obsValues = {};
                opParams.labels.forEach((label, j) => {
                    const inputName = label.replace(/[^a-zA-Z0-9]/g, '');
                    obsValues[inputName] = values[j] || '';
                });
                dataMap[r.operation] = { 
                    ...r, 
                    obsValues, 
                    inspectionStatus: r.inspectionStatus || 'N/A',
                    operatorChecked: r.operatorChecked || '', 
                    supervisorSign: r.supervisorSign || ''
                }; 
            });
            return dataMap;
        };

        const savedDataMap = mapSavedData(savedRows);
        
        predefinedOperations.forEach((opConfig, index) => {
            const srCount = index + 1;
            const opName = opConfig.op;
            const opParams = PARAMETERS[opName];
            
            const savedData = savedDataMap[opName] || { obsValues: {}, inspectionStatus: 'N/A', operatorChecked: '', supervisorSign: '' };
            
            const div = document.createElement('div');
            div.dataset.sr = srCount;
            div.dataset.operation = opName;
            div.className = 'row-group';
            
            let obsFieldsHTML = '';
            
            opParams.labels.forEach((label, j) => {
                if (label !== "N/A") {
                    const unit = opParams.units[j];
                    const inputName = label.replace(/[^a-zA-Z0-9]/g, ''); 
                    const placeholder = `${label} ${unit ? '(' + unit + ')' : ''}`;
                    const savedValue = savedData.obsValues[inputName] || '';
                    
                    obsFieldsHTML += `
                        <div>
                            <label>${placeholder}</label>
                            <input data-field="obsParam" data-param="${inputName}" type="text" placeholder="${placeholder}" value="${savedValue}" />
                        </div>
                    `;
                }
            });
            
            div.innerHTML = `
                <div class="row-header">
                    <span>${srCount}. ${opName}</span>
                    <span>Date: 
                        <input data-field="dateShift" type="text" placeholder="Date/Shift" value="${savedData.dateShift || ''}" style="width:100px; display:inline-block; margin-top:0;" />
                    </span>
                </div>
                
                <div class="row-detail-grid">
                    <div><label>From Time</label><input data-field="fromTime" type="text" placeholder="From T." value="${savedData.fromTime || ''}" /></div>
                    <div><label>To Time</label><input data-field="toTime" type="text" placeholder="To T." value="${savedData.toTime || ''}" /></div>
                    <div><label>Qty (Pcs)</label><input data-field="qty" type="text" placeholder="Qty" value="${savedData.qty || ''}" /></div>
                    <div>
                        <label>Inspection OK/NOK</label>
                        <select data-field="inspectionStatus">
                            <option value="N/A" ${savedData.inspectionStatus === 'N/A' ? 'selected' : ''}>N/A</option>
                            <option value="OK" ${savedData.inspectionStatus === 'OK' ? 'selected' : ''}>OK</option>
                            <option value="NOK" ${savedData.inspectionStatus === 'NOK' ? 'selected' : ''}>NOK</option>
                        </select>
                    </div>
                </div>

                <div class="observation-fields row-detail-grid ${opParams.labels.length <= 1 ? 'full-width-grid' : ''}">
                    ${obsFieldsHTML}
                </div>
                
                <div class="operator-supervisor-grid">
                    <div>
                        <label>Operator / Checked</label>
                        <input data-field="operatorChecked" type="text" placeholder="Name / Sign" value="${savedData.operatorChecked || ''}" />
                    </div>
                    <div>
                        <label>Supervisor Sign/Name</label>
                        <input data-field="supervisorSign" type="text" placeholder="Name / Sign" value="${savedData.supervisorSign || ''}" />
                    </div>
                </div>
            `;

            div.querySelectorAll('input, select').forEach(inp => { 
                inp.addEventListener('change', applyPreview);
                inp.addEventListener('input', applyPreview); 
            });
            
            rowsInputContainer.appendChild(div);
        });
        
        applyPreview(); 
    }

    function getFormData() {
      const data = {};
      jobFields.forEach(f=> data[f] = document.getElementById(f).value.trim());
      
      const cleanCustomer = data.customerName.replace(/[^a-zA-Z0-9]/g, '_').replace(/_{2,}/g, '_').trim();
      const cleanPart = data.partDesc.replace(/[^a-zA-Z0-9]/g, '_').replace(/_{2,}/g, '_').trim();
      const cleanChallan = data.challan.replace(/[^a-zA-Z0-9]/g, '_').replace(/_{2,}/g, '_').trim();
      
      data.uniqueId = `${cleanCustomer.substring(0, 3)}_${cleanPart}_${cleanChallan}`;
      if(data.uniqueId.length < 5) {
           data.uniqueId = `NEW_${Date.now()}`;
      }
      data.uniqueId = data.uniqueId.toUpperCase();
      
      const rows = [];
      document.getElementById('rowsInput').querySelectorAll('.row-group').forEach((group, index)=>{
        const operation = group.dataset.operation || '';
        const opParams = PARAMETERS[operation];
        
        let observationValues = [];
        
        opParams.labels.forEach((label) => {
            if (label !== "N/A") {
                const inputName = label.replace(/[^a-zA-Z0-9]/g, '');
                const inputElement = group.querySelector(`input[data-field="obsParam"][data-param="${inputName}"]`);
                observationValues.push(inputElement?.value.trim() || '');
            }
        });
        
        const observation = observationValues.join(', ').trim(); 

        const dateShiftValue = group.querySelector('input[data-field="dateShift"]').value.trim();
        if (operation.includes('Spare Operation') && observation.replace(/, /g, '').length === 0 && dateShiftValue === '') return;
        
        rows.push({
          sr: index + 1,
          dateShift: dateShiftValue,
          observation: observation, 
          paramStructure: opParams, 
          fromTime: group.querySelector('input[data-field="fromTime"]').value.trim(),
          toTime: group.querySelector('input[data-field="toTime"]').value.trim(),
          qty: group.querySelector('input[data-field="qty"]').value.trim(),
          inspectionStatus: group.querySelector('select[data-field="inspectionStatus"]').value, 
          operatorChecked: group.querySelector('input[data-field="operatorChecked"]').value.trim(),
          supervisorSign: group.querySelector('input[data-field="supervisorSign"]').value.trim(), 
          operation: operation, 
        });
      });
      data.rows = rows;
      
      return data;
    }

    // --- CLOUD ACTIONS ---

    async function saveOrUpdateReport() {
        if (!window.auth || !window.auth.currentUser) {
            alert("‚ùå Save Error: Cloud Save ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ü‡§™‡§ï‡•ã LOGIN ‡§ï‡§∞‡§®‡§æ ‡§π‡•ã‡§ó‡§æ‡•§");
            return;
        }
        
        const data = getFormData();
        const docId = data.uniqueId;

        if (!data.customerName || !data.partDesc || !data.challan || docId.length < 5) {
             alert("‚ùå Save Error: Customer Name, Part Desc, ‡§î‡§∞ Challan No. ‡§≠‡§∞‡•á‡§Ç‡•§");
             return;
        }

        const saveButton = document.getElementById('saveReport');
        saveButton.textContent = "Saving... Wait!";
        saveButton.disabled = true;

        try {
            await window.cloudSaveReport(data, docId); 
            alert(`‚úÖ Job Card ${docId} SAVED/UPDATED in Cloud Database.`);
            currentActiveReportId = docId;
            updateActionButtons(docId); 
            fetchAndDisplayReports(''); // Refresh list
        } catch (error) {
            alert(`‚ùå Cloud Save Error: ${error.message}.`);
            console.error("Firebase Save Error:", error);
        } finally {
            saveButton.disabled = false;
        }
    }

    async function fetchAndDisplayReports(query = '') {
        const reportListContainer = document.getElementById('reportListContainer');
        if (!window.auth || !window.auth.currentUser) {
             reportListContainer.innerHTML = `<div style="padding:10px; text-align:center;">Login is required to load reports from Cloud.</div>`;
             return;
        }
        
        reportListContainer.innerHTML = `<div style="padding:10px; text-align:center; color:#2563eb;">Loading reports from Cloud...</div>`;

        try {
            let allReportsArray = await window.cloudLoadReports(query);

            if (allReportsArray.length === 0) {
                reportListContainer.innerHTML = `<div style="padding:10px; text-align:center; color:#999;">‡§ï‡•ã‡§à ‡§∏‡•á‡§µ‡•ç‡§° ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§</div>`;
                return;
            }

            allReportsArray.sort((a, b) => {
                return new Date(b.updatedAt || b.timestamp) - new Date(a.updatedAt || a.timestamp);
            });

            reportListContainer.innerHTML = '';
            
            allReportsArray.forEach(r => {
                const displayText = `${r.customerName || 'N/A Cust'} | ${r.partDesc || 'N/A Part'} | Challan: ${r.challan || 'N/A'}`;
                const dateText = new Date(r.updatedAt || r.timestamp).toLocaleDateString('en-GB') || 'Unknown Date';

                const div = document.createElement('div');
                div.className = 'report-item';
                if(r.uniqueId === currentActiveReportId) div.classList.add('selected'); 
                div.dataset.id = r.uniqueId; 
                div.innerHTML = `<span class="part-info">${displayText}</span><small style="color:#888;">${dateText}</small>`;
                
                div.addEventListener('click', loadReport); 
                reportListContainer.appendChild(div);
            });

        } catch (error) {
             reportListContainer.innerHTML = `<div style="padding:10px; text-align:center; color:#dc2626;">Error loading reports: ${error.message}</div>`;
        }
    }

    async function deleteReport() {
        const idToDelete = currentActiveReportId;
        
        if (!idToDelete) { alert("Cannot delete: Please select a saved report first."); return; }
        if (!window.auth.currentUser) { alert("Login required to delete."); return; }

        const confirmDelete = confirm(`‚ö†Ô∏è Are you sure you want to DELETE Job Card ${idToDelete} permanently from the Cloud?`);
        
        if (confirmDelete) {
            try {
                await window.cloudDeleteReport(idToDelete);
                alert(`üóëÔ∏è Job Card ${idToDelete} Cloud ‡§∏‡•á ‡§π‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§`);
                clearForm(); 
                fetchAndDisplayReports(''); 
            } catch (error) {
                alert(`‚ùå Cloud Delete Error: ${error.message}.`);
            }
        }
    }

    function loadReport(e) {
        const id = e.currentTarget.dataset.id;
        const reports = Array.from(document.getElementById('reportListContainer').children)
                             .map(el => el.reportData)
                             .filter(d => d);
        const reportData = reports.find(r => r.uniqueId === id);

        if (!reportData) { 
            alert(`‚ùå Report ID ${id} ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§`); 
            return; 
        }
        
        document.querySelectorAll('.report-item').forEach(item => item.classList.remove('selected'));
        e.currentTarget.classList.add('selected');
        
        jobFields.forEach(f => {
            const el = document.getElementById(f);
            if (el) el.value = reportData[f] || '';
        });

        updateActionButtons(id); 
        
        updateRowInputs(reportData.rows || []); 
        applyPreview(); 
    }

    // --- UI/Utility Functions (No Change) ---
    function updateActionButtons(id = null) {
        currentActiveReportId = id;
        document.getElementById('deleteReport').disabled = !id || (window.auth && !window.auth.currentUser); 
        document.getElementById('currentReportId').textContent = `Active ID: ${id || '-- New --'}`;
        document.getElementById('saveReport').textContent = currentActiveReportId ? 'üíæ Update Report' : 'üíæ Save New Report';
    }

    function clearForm() {
        // Clear all fields to their default or empty values
        jobFields.forEach(f => {
            const el = document.getElementById(f);
            if (el.type === 'text' || el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                 el.value = ''; 
            } else if (el.tagName === 'SELECT') {
                 el.value = el.options[0].value;
            }
        });
        
        // Default values for a new form
        document.getElementById('customerName').value = "Star Engineering";
        document.getElementById('challan').value = "CH/2508/01 | 01.09.2025";
        document.getElementById('batchNo').value = "250819";
        document.getElementById('verifiedBy').value = "SAKSHI CHAVHAN";
        document.getElementById('approvedBy').value = "ABHIJEET DHOKRAT";
        document.getElementById('notes').value = "Job Card initiated with Batch 250819.";

        // Default paint: Black
        document.getElementById('paint').value = 'Black'; 
        
        updateRowInputs(); 
        updateActionButtons(null); 
        applyPreview();
    }
    
    function applyPreview() {
        // ... (Preview Logic is unchanged, using getFormData()) ...
        const data = getFormData();
        const v = (id) => document.getElementById(id).value;
        
        document.getElementById('pvCustomer').textContent = v('customerName');
        document.getElementById('pvQty').textContent = v('orderQty');
        document.getElementById('pvChallan').textContent = v('challan');
        document.getElementById('pvPart').textContent = v('partDesc');
        document.getElementById('pvCoating').textContent = v('coatingSpec');
        document.getElementById('pvPaint').textContent = v('paint');
        document.getElementById('pvBatch').textContent = v('batchNo');
        document.getElementById('pvVerified').textContent = v('verifiedBy');
        document.getElementById('pvApproved').textContent = v('approvedBy');
        document.getElementById('pvNotes').textContent = v('notes');

        const tbody = document.getElementById('pvRows');
        tbody.innerHTML = '';
        
        const allRows = data.rows;
        let globalSr = 1; 

        allRows.forEach(r => {
            const values = (r.observation || '').split(',').map(v => v.trim()); 
            const structure = PARAMETERS[r.operation]; 
            
            let filteredDetails = [];
            for (let j = 0; j < structure.labels.length; j++) {
                const label = structure.labels[j];
                const unit = structure.units[j];
                const value = values[j] || ''; 
                
                if (label !== "N/A" && (label.trim().length > 0 || value.trim().length > 0)) {
                    const display = `<b>${label}:</b> ${value} ${unit}`;
                    filteredDetails.push({ display, label, value });
                }
            }
            
            const rowspanCount = Math.max(filteredDetails.length, 1);
            
            for (let index = 0; index < rowspanCount; index++) {
                const tr = document.createElement('tr');
                let rowContent = '';
                
                const detail = filteredDetails[index] || { display: '', label: '', value: '' };

                if (index === 0) {
                    rowContent += `
                        <td style="text-align:center" rowspan="${rowspanCount}">${globalSr}</td>
                        <td rowspan="${rowspanCount}">${r.dateShift || ''}</td>
                        <td rowspan="${rowspanCount}">${r.operation || ''}</td>
                    `;
                    globalSr++;
                }
                
                const displayFromTime = index === 0 ? (r.fromTime || '') : '';
                const displayToTime = index === 0 ? (r.toTime || '') : '';
                const displayQty = index === 0 ? (r.qty || '') : '';
                const displayInspection = index === 0 ? (r.inspectionStatus || '') : ''; 
                const displayOperatorChecked = index === 0 ? (r.operatorChecked || '') : ''; 
                const displaySupervisorSign = index === 0 ? (r.supervisorSign || '') : ''; 
                
                let finalDisplay = detail.display;
                if (finalDisplay.endsWith('<b>:</b> ')) { finalDisplay = finalDisplay.substring(0, finalDisplay.length - 8); }

                rowContent += `
                    <td>${finalDisplay || ''}</td>
                    <td style="text-align:center">${displayFromTime}</td>
                    <td style="text-align:center">${displayToTime}</td>
                    <td style="text-align:center">${displayQty}</td>
                    <td style="text-align:center; font-weight: bold;">${displayInspection}</td> 
                    <td>${displayOperatorChecked}</td>
                    <td>${displaySupervisorSign}</td>
                `;

                tr.innerHTML = rowContent;
                tbody.appendChild(tr);
            }
        });
        
        let currentOutputRows = tbody.querySelectorAll('tr').length;
        const MIN_OUTPUT_ROWS = 10; 
        
        if (currentOutputRows < MIN_OUTPUT_ROWS) {
            for (let i = 0; i < MIN_OUTPUT_ROWS - currentOutputRows; i++) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td style="text-align:center">${globalSr + i}</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>`; 
                tbody.appendChild(tr);
            }
        }
    }
    
    // --- EVENT LISTENERS ---
    
    document.getElementById('signUpButton').addEventListener('click', () => window.handleAuthAction('signup'));
    document.getElementById('loginButton').addEventListener('click', () => window.handleAuthAction('signin'));
    document.getElementById('logoutButton').addEventListener('click', () => window.handleAuthAction('logout'));

    document.getElementById('saveReport').addEventListener('click', saveOrUpdateReport);
    document.getElementById('deleteReport').addEventListener('click', deleteReport);
    document.getElementById('applyBtn').addEventListener('click', applyPreview);
    document.getElementById('updateOpsBtn').addEventListener('click', updateRowInputs);
    document.getElementById('clearBtn').addEventListener('click', clearForm);
    document.getElementById('newReportBtn').addEventListener('click', clearForm);

    jobFields.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('change', applyPreview);
    });

    document.getElementById('searchBtn').addEventListener('click', () => {
         const query = document.getElementById('reportSearch').value;
         fetchAndDisplayReports(query);
    });

    document.getElementById('reportSearch').addEventListener('input', (e) => {
        const query = e.target.value;
        fetchAndDisplayReports(query); 
    });
    
    document.getElementById('paint').addEventListener('change', () => {
        updateRowInputs(); 
    });

    // PDF/Print Listeners (Unchanged)
    document.getElementById('downloadPdfBtn').addEventListener('click', async () => {
        applyPreview(); 
        const previewEl = document.getElementById('preview');
        
        const canvas = await html2canvas(previewEl, { scale: 2, useCORS: true });
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();
        const imgHeight = (canvas.height * pdfWidth) / canvas.width;
        
        let position = 0;
        
        if (imgHeight > pdfHeight) {
            let heightLeft = imgHeight;
            let page = 1;
            
            while (heightLeft > 0) {
                if (page > 1) {
                    pdf.addPage();
                    position = - (pdfHeight * (page - 1));
                }
                pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                heightLeft -= pdfHeight;
                page++;
            }
        } else {
             pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, imgHeight);
        }

        const fileName = `JobCard_${document.getElementById('challan').value.replace(/[^a-zA-Z0-9]/g, '_')}_${document.getElementById('batchNo').value}.pdf`;
        pdf.save(fileName);
    });

    document.getElementById('printBtn').addEventListener('click', () => {
        applyPreview(); 
        window.print();
    });

    document.addEventListener('DOMContentLoaded', () => {
        updateRowInputs(); 
        // Initial fetch will happen via the Firebase Auth Listener (updateAuthUI)
    });
  </script>
</body>
</html>